generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Product {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  slug              String      @unique(map: "product_slug_idx")
  category          String
  subCategory       String?
  images            String[]
  imageColors       String[]    @default([])
  brand             String
  description       String
  streetAddress     String?
  unitNumber        String?
  stock             Int
  price             Decimal     @default(0) @db.Decimal(12, 2)
  rating            Decimal     @default(0) @db.Decimal(3, 2)
  numReviews        Int         @default(0)
  bedrooms          Int?
  bathrooms         Decimal?    @db.Decimal(3, 1)
  sizeSqFt          Int?
  isFeatured        Boolean     @default(false)
  banner            String?
  printfulProductId String?
  onSale            Boolean     @default(false)
  salePercent       Decimal?    @db.Decimal(5, 2)
  saleUntil         DateTime?   @db.Timestamp(6)
  videoUrl          String? // Property video URL
  virtualTourUrl    String? // 3D walkthrough URL (Matterport, etc.)
  createdAt         DateTime    @default(now()) @db.Timestamp(6)
  OrderItem         OrderItem[]
  Review            Review[]

  variants      ProductVariant[]
  productPromos ProductPromo[]
}

model User {
  id                      String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String                           @default("NO_NAME")
  email                   String                           @unique(map: "user_email_idx")
  emailVerified           DateTime?                        @db.Timestamp(6)
  image                   String?
  password                String?
  role                    String                           @default("user")
  shippingAddress         Json?                            @db.Json
  billingAddress          Json?                            @db.Json
  address                 Json?                            @db.Json
  paymentMethod           String?
  stripeCustomerId        String?
  phoneNumber             String?
  phoneVerified           DateTime?                        @db.Timestamp(6)
  notificationPreferences Json?                            @db.Json // { email: boolean, sms: boolean, both: boolean }
  isBlocked               Boolean                          @default(false)
  blockedAt               DateTime?                        @db.Timestamp(6)
  blockedBy               String?                          @db.Uuid
  blockedReason           String?
  createdAt               DateTime                         @default(now()) @db.Timestamp(6)
  updatedAt               DateTime                         @updatedAt
  account                 Account[]
  session                 Session[]
  Cart                    Cart[]
  Order                   Order[]
  Review                  Review[]
  savedPaymentMethods     SavedPaymentMethod[]
  paymentMethodTokens     PaymentMethodVerificationToken[]
  threadParticipants      ThreadParticipant[]
  friends                 Friend[]                         @relation("UserFriends")
  friendOf                Friend[]                         @relation("UserFriendOf")
  blogPosts               BlogPost[]
  blogComments            BlogComment[]
  blogReactions           BlogReaction[]
  leasesAsTenant          Lease[]
  rentPayments            RentPayment[]
  cashPayments            CashPayment[]
  maintenanceTickets      MaintenanceTicket[]
  rentalApplications      RentalApplication[]
  landlordsOwned          Landlord[]
  notifications           Notification[]
  uploadedDocuments       ScannedDocument[]

  applicationDocuments     ApplicationDocument[]
  uploadedVerificationDocs VerificationDocument[] @relation("UploadedVerificationDocs")
  reviewedVerificationDocs VerificationDocument[] @relation("ReviewedVerificationDocs")

  leaseViolations LeaseViolation[]
  tenantInvoices  TenantInvoice[]

  // Contractor management
  contractorProfile Contractor[]
  workOrderMedia    WorkOrderMedia[]
  workOrderHistory  WorkOrderHistory[]

  // Team Operations (Enterprise)
  teamMemberships         TeamMember[]
  reviewedTimeOffRequests TimeOffRequest[] @relation("TimeOffReviewer")
  reviewedTimesheets      Timesheet[]      @relation("TimesheetReviewer")

  // Onboarding
  onboardingCompleted Boolean @default(false)
  onboardingStep      String? // Current step in onboarding flow

  // Two-Factor Authentication (Email-based)
  twoFactorEnabled Boolean @default(false)

  // Real Estate Agent
  agentProfile Agent?

  // Homeowner
  homeownerProfile Homeowner?

  // Contractor Marketplace
  contractorMarketplaceProfile ContractorProfile?
  contractorReviewsGiven       ContractorReview[] @relation("ContractorReviewsGiven")
  contractorLeadsSubmitted     ContractorLead[]

  // Dispute Center
  disputesFiled    Dispute[]         @relation("DisputeFiledBy")
  disputesAssigned Dispute[]         @relation("DisputeAssignedTo")
  disputesResolved Dispute[]         @relation("DisputeResolvedBy")
  disputeMessages  DisputeMessage[]
  disputeEvidence  DisputeEvidence[]
  disputeTimeline  DisputeTimeline[]
  recurringCharges RecurringCharge[]
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @id
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamp(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model EmailVerificationToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PasswordResetToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PhoneVerificationToken {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String   @db.Uuid
  phone    String
  otp      String
  expires  DateTime
  attempts Int      @default(0)

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([userId])
  @@index([phone])
}

model Cart {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?  @db.Uuid
  sessionCartId String
  items         Json[]   @default([]) @db.Json
  itemsPrice    Decimal  @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2)
  shippingPrice Decimal  @db.Decimal(12, 2)
  taxPrice      Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String      @db.Uuid
  shippingAddress    Json        @db.Json
  paymentMethod      String
  paymentResult      Json?       @db.Json
  itemsPrice         Decimal     @db.Decimal(12, 2)
  shippingPrice      Decimal     @db.Decimal(12, 2)
  taxPrice           Decimal     @db.Decimal(12, 2)
  totalPrice         Decimal     @db.Decimal(12, 2)
  isPaid             Boolean     @default(false)
  paidAt             DateTime?   @db.Timestamp(6)
  isDelivered        Boolean     @default(false)
  deliveredAt        DateTime?   @db.Timestamp(6)
  trackingNumber     String?     @unique
  trackingStatus     String?     @default("pending")
  trackingEvents     Json[]      @default([]) @db.Json
  lastTrackingUpdate DateTime?   @db.Timestamp(6)
  createdAt          DateTime    @default(now()) @db.Timestamp(6)
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderitems         OrderItem[]
}

model OrderItem {
  orderId      String  @db.Uuid
  productId    String  @db.Uuid
  qty          Int
  price        Decimal @db.Decimal(12, 2)
  name         String
  slug         String
  image        String
  variantId    String? @db.Uuid
  variantColor String?
  variantSize  String?
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([orderId, productId], map: "orderitems_orderId_productId_pk")
}

model Color {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  hex       String?
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model Size {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model ProductVariant {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId          String   @db.Uuid
  sku                String?  @unique
  colorId            String?  @db.Uuid
  sizeId             String?  @db.Uuid
  images             String[] @default([])
  price              Decimal  @db.Decimal(12, 2)
  stock              Int
  printfulExternalId String?
  createdAt          DateTime @default(now()) @db.Timestamp(6)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  color   Color?  @relation(fields: [colorId], references: [id], onDelete: SetNull)
  size    Size?   @relation(fields: [sizeId], references: [id], onDelete: SetNull)
}

model Review {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @db.Uuid
  productId          String   @db.Uuid
  rating             Int
  title              String
  description        String
  isVerifiedPurchase Boolean  @default(true)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedPaymentMethod {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  stripePaymentMethodId String   @unique
  type                  String
  cardholderName        String?
  last4                 String
  expirationDate        String?
  brand                 String?
  billingAddress        Json?    @db.Json
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentMethodId])
}

model PaymentMethodVerificationToken {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @db.Uuid
  paymentMethodId String   @db.Uuid
  token           String   @unique
  expires         DateTime
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Coupon {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String    @unique
  description    String?
  discountType   String    @default("percentage")
  discountValue  Decimal   @db.Decimal(10, 2)
  minOrderAmount Decimal?  @db.Decimal(12, 2)
  maxUses        Int?
  usedCount      Int       @default(0)
  isActive       Boolean   @default(true)
  expiresAt      DateTime?
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt

  @@index([code])
}

model PromoCode {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String    @unique
  description    String?
  discountType   String    @default("percentage")
  discountValue  Decimal   @db.Decimal(10, 2)
  minOrderAmount Decimal?  @db.Decimal(12, 2)
  maxUses        Int?
  usedCount      Int       @default(0)
  isActive       Boolean   @default(true)
  expiresAt      DateTime?
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt

  productPromos ProductPromo[]

  @@index([code])
}

model ProductPromo {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId   String @db.Uuid
  promoCodeId String @db.Uuid

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@unique([productId, promoCodeId])
}

model ShippingSettings {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  baseShippingCost       Decimal  @db.Decimal(10, 2)
  freeShippingThreshold  Decimal  @db.Decimal(12, 2)
  uspsIntegrationEnabled Boolean  @default(false)
  updatedAt              DateTime @updatedAt

  @@unique([id])
}

model TaxSettings {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taxRate   Decimal  @db.Decimal(5, 2)
  updatedAt DateTime @updatedAt

  @@unique([id])
}

// Cash payment tracking for retail location payments
model CashPayment {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  referenceId        String    @unique
  paymentIntentId    String    @db.Uuid
  tenantId           String    @db.Uuid
  propertyId         String    @db.Uuid
  amount             Decimal   @db.Decimal(10, 2)
  fee                Decimal   @db.Decimal(10, 2)
  status             String    @default("pending") // pending, completed, expired, failed
  partnerId          String // paynearme, greendot, moneygram
  barcodeData        String // JSON data for barcode
  confirmationNumber String? // Retail location confirmation
  expiresAt          DateTime
  processedAt        DateTime?
  createdAt          DateTime  @default(now()) @db.Timestamp(6)
  updatedAt          DateTime  @updatedAt @db.Timestamp(6)

  tenant   User     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([referenceId])
  @@index([tenantId])
  @@index([propertyId])
  @@index([status])
  @@index([expiresAt])
}

model Thread {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type            String   @default("contact") // contact, support, dm
  subject         String?
  fromEmail       String?
  toEmail         String?
  createdByUserId String?  @db.Uuid
  status          String   @default("open") // open, closed, pending
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt

  messages     Message[]
  participants ThreadParticipant[]
}

model Message {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId     String   @db.Uuid
  senderUserId String?  @db.Uuid
  senderName   String?
  senderEmail  String?
  content      String
  role         String   @default("user") // user, admin, system, ai
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model ThreadParticipant {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId   String    @db.Uuid
  userId     String    @db.Uuid
  lastReadAt DateTime?

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model Friend {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  friendId  String   @db.Uuid
  status    String   @default("pending") // pending, accepted, declined, blocked
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user   User @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("UserFriendOf", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model BlogPost {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  slug        String   @unique
  excerpt     String?
  contentHtml String
  coverImage  String?
  mediaUrls   String[] @default([])
  tags        String[] @default([])
  isPublished Boolean  @default(true)
  authorId    String?  @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  comments  BlogComment[]
  reactions BlogReaction[]
}

model BlogComment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postId    String   @db.Uuid
  userId    String   @db.Uuid
  content   String
  createdAt DateTime @default(now()) @db.Timestamp(6)

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model BlogReaction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postId    String   @db.Uuid
  userId    String   @db.Uuid
  type      String   @default("like") // like/heart, future types
  createdAt DateTime @default(now()) @db.Timestamp(6)

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
  @@index([postId])
}

model AnalyticsEvent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionCartId String
  userId        String?  @db.Uuid
  path          String
  referrer      String?
  country       String?
  region        String?
  city          String?
  userAgent     String?
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  @@index([sessionCartId])
  @@index([userId])
  @@index([path])
  @@index([createdAt])
}

model SupportStatus {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  isOnline  Boolean  @default(true)
  updatedBy String?  @db.Uuid
  updatedAt DateTime @default(now()) @db.Timestamp(6)
}

model Landlord {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  subdomain              String   @unique
  ownerUserId            String?  @db.Uuid
  stripeConnectAccountId String?
  stripeOnboardingStatus String?
  createdAt              DateTime @default(now()) @db.Timestamp(6)
  updatedAt              DateTime @updatedAt

  inviteViaEmail Boolean @default(true)
  inviteViaSms   Boolean @default(false)

  // Branding
  logoUrl        String?
  customDomain   String?  @unique
  companyName    String?
  companyEmail   String?
  companyPhone   String?
  companyAddress String?
  themeColor     String   @default("violet") // violet, emerald, blue, rose, amber
  heroImages     String[] @default([]) // up to 3 hero images for portal
  aboutBio       String?
  aboutPhoto     String?
  aboutGallery   String[] @default([])

  // Onboarding / intake fields
  unitsEstimateMin Int?
  unitsEstimateMax Int?
  ownsProperties   Boolean? @default(false)
  managesForOthers Boolean? @default(false)
  useSubdomain     Boolean  @default(true)

  // Subscription & Tier
  subscriptionTier           String    @default("starter") // starter, pro, enterprise
  stripeSubscriptionId       String?
  stripeCustomerId           String?
  subscriptionStatus         String    @default("active") // active, past_due, canceled, trialing
  subscriptionEndsAt         DateTime? @db.Timestamp(6)
  unitLimitNotifiedAt        DateTime? @db.Timestamp(6) // last time we sent unit limit warning
  freeBackgroundChecks       Boolean   @default(false)
  freeEmploymentVerification Boolean   @default(false)

  // Notification Settings
  notificationEmail        String?
  notifyNewApplications    Boolean @default(true)
  notifyMaintenanceTickets Boolean @default(true)
  notifyLatePayments       Boolean @default(true)
  notifyLeaseExpiring      Boolean @default(true)
  notifyNewMessages        Boolean @default(true)
  emailInvitesEnabled      Boolean @default(true)
  smsInvitesEnabled        Boolean @default(false)

  // Fee Settings
  petDepositAmount      Decimal? @db.Decimal(12, 2)
  petDepositEnabled     Boolean  @default(false)
  petRentAmount         Decimal? @db.Decimal(12, 2)
  petRentEnabled        Boolean  @default(false)
  cleaningFeeAmount     Decimal? @db.Decimal(12, 2)
  cleaningFeeEnabled    Boolean  @default(false)
  applicationFeeAmount  Decimal? @db.Decimal(12, 2)
  applicationFeeEnabled Boolean  @default(true)
  securityDepositMonths Decimal  @default(1) @db.Decimal(3, 1)
  lastMonthRentRequired Boolean  @default(true)
  feeApplyToAll         Boolean  @default(true)
  feeSelectedProperties String[] @default([])

  owner                User?                        @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  properties           Property[]
  payouts              Payout[]
  platformFees         PlatformFee[]
  savedPayoutMethods   SavedPayoutMethod[]
  legalDocuments       LegalDocument[]
  quickBooksConnection QuickBooksConnection?
  docuSignConnection   DocuSignConnection?
  scannedDocuments     ScannedDocument[]
  classificationRules  DocumentClassificationRule[]
  subscription         LandlordSubscription?

  expenses         Expense[]
  marketBenchmarks MarketBenchmark[]

  leaseViolations LeaseViolation[]

  applicationDocuments        ApplicationDocument[]
  verificationDocuments       VerificationDocument[]        @relation("VerificationDocuments")
  employmentVerificationUsage EmploymentVerificationUsage[] @relation("EmploymentVerificationUsage")
  wallet                      LandlordWallet?

  // Lease Templates
  leaseTemplates LeaseTemplate[]

  // Contractor management
  contractors         Contractor[]
  contractorInvites   ContractorInvite[]
  workOrders          WorkOrder[]
  contractorPayments  ContractorPayment[]
  contractorEstimates ContractorEstimate[]

  // Team Operations (Enterprise)
  teamMembers     TeamMember[]
  shifts          Shift[]
  timeEntries     TimeEntry[]
  timesheets      Timesheet[]
  teamPayments    TeamPayment[]
  timeOffRequests TimeOffRequest[]
  payrollSettings PayrollSettings?

  // Hiring (Enterprise)
  jobPostings   JobPosting[]
  jobApplicants JobApplicant[]

  // Affiliate tracking
  affiliateReferral AffiliateReferral?

  // Dispute Center
  disputes Dispute[]

  // Enterprise API & Webhooks
  apiKeys          ApiKey[]
  webhookEndpoints WebhookEndpoint[]
  apiRequestLogs   ApiRequestLog[]
  recurringCharges RecurringCharge[]
}

// Homeowner - A homeowner who hires contractors for their home
model Homeowner {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @unique @db.Uuid
  name               String? // Home name (e.g., "My Beach House")
  homeType           String? // single_family, townhouse, condo, multi_family
  interestedServices String[] @default([])
  projectTimeline    String? // urgent, this_week, this_month, planning
  address            Json?    @db.Json
  images             String[] @default([])
  yearBuilt          Int?
  squareFootage      Int?
  bedrooms           Int?
  bathrooms          Decimal? @db.Decimal(3, 1)
  lotSize            String?
  description        String?
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @updatedAt

  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  workOrders HomeownerWorkOrder[]

  @@index([userId])
}

// HomeownerWorkOrder - Work orders created by homeowners
model HomeownerWorkOrder {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  homeownerId   String    @db.Uuid
  contractorId  String?   @db.Uuid
  title         String
  description   String
  category      String // plumbing, electrical, hvac, painting, landscaping, general
  status        String    @default("open") // open, assigned, in_progress, completed, cancelled
  priority      String    @default("medium") // low, medium, high, urgent
  budgetMin     Decimal?  @db.Decimal(12, 2)
  budgetMax     Decimal?  @db.Decimal(12, 2)
  agreedPrice   Decimal?  @db.Decimal(12, 2)
  scheduledDate DateTime? @db.Timestamp(6)
  completedAt   DateTime? @db.Timestamp(6)
  address       Json?     @db.Json
  images        String[]  @default([])
  notes         String?
  isOpenBid     Boolean   @default(true)
  bidDeadline   DateTime? @db.Timestamp(6)
  createdAt     DateTime  @default(now()) @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt

  homeowner Homeowner               @relation(fields: [homeownerId], references: [id], onDelete: Cascade)
  bids      HomeownerWorkOrderBid[]

  @@index([homeownerId])
  @@index([status])
  @@index([isOpenBid])
}

// HomeownerWorkOrderBid - Contractor bids on homeowner jobs
model HomeownerWorkOrderBid {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workOrderId       String    @db.Uuid
  contractorId      String    @db.Uuid
  amount            Decimal   @db.Decimal(12, 2)
  estimatedHours    Decimal?  @db.Decimal(6, 2)
  proposedStartDate DateTime? @db.Timestamp(6)
  message           String?
  status            String    @default("pending") // pending, accepted, declined, withdrawn
  createdAt         DateTime  @default(now()) @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt

  workOrder HomeownerWorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@unique([workOrderId, contractorId])
  @@index([workOrderId])
  @@index([contractorId])
}

model QuickBooksConnection {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String    @unique @db.Uuid
  realmId               String?
  accessTokenEncrypted  String?
  refreshTokenEncrypted String?
  accessTokenExpiresAt  DateTime?
  oauthState            String?
  connectedAt           DateTime?
  createdAt             DateTime  @default(now()) @db.Timestamp(6)
  updatedAt             DateTime  @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([realmId])
}

model DocuSignConnection {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String    @unique @db.Uuid
  accessTokenEncrypted  String?
  refreshTokenEncrypted String?
  accessTokenExpiresAt  DateTime?
  oauthState            String?
  connectedAt           DateTime?
  createdAt             DateTime  @default(now()) @db.Timestamp(6)
  updatedAt             DateTime  @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
}

model SavedPayoutMethod {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @db.Uuid
  stripePaymentMethodId String   @unique
  type                  String // 'bank_account' or 'card' (for instant payouts)
  accountHolderName     String?
  last4                 String
  bankName              String?
  accountType           String? // 'checking' or 'savings'
  routingNumber         String?
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt
  landlord              Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([stripePaymentMethodId])
}

model Property {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String    @unique
  description String?
  address     Json      @db.Json
  type        String // e.g. apartment, house, office, mixed-use
  status      String    @default("active") // active, paused, suspended, deleted
  deletedAt   DateTime? @db.Timestamp(6) // Soft delete timestamp - preserves payment history
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime  @updatedAt

  landlordId             String? @db.Uuid
  defaultLeaseDocumentId String? @db.Uuid // Default lease template for this property

  // Fee settings for this property
  cleaningFee      Decimal? @db.Decimal(12, 2) // One-time cleaning fee
  petDepositAnnual Decimal? @db.Decimal(12, 2) // Annual pet deposit fee

  // Video and virtual tour
  videoUrl       String? // Property video URL (uploaded or YouTube/Vimeo)
  virtualTourUrl String? // 3D walkthrough URL (Matterport, etc.)

  // Property-level amenities (pool, gym, parking, laundry room, etc.)
  amenities String[] @default([])

  landlord             Landlord?      @relation(fields: [landlordId], references: [id], onDelete: SetNull)
  defaultLeaseDocument LegalDocument? @relation("DefaultLeaseDocument", fields: [defaultLeaseDocumentId], references: [id], onDelete: SetNull)

  units        Unit[]
  cashPayments CashPayment[]
  inspections  PropertyInspection[]
  schedule     PropertySchedule?
  appointments PropertyAppointment[]

  finance          PropertyFinance?
  expenses         Expense[]
  marketBenchmarks MarketBenchmark[]
  bankAccount      PropertyBankAccount?
  invoices         TenantInvoice[]

  // Tenant lifecycle relations
  tenantHistory TenantHistory[]

  // Contractor work orders
  workOrders WorkOrder[]

  // Lease template assignment
  leaseTemplateAssignment PropertyLeaseTemplate?

  // Property-specific fee settings
  feeSettings PropertyFeeSettings?

  // Team Operations (Enterprise)
  shifts      Shift[]
  timeEntries TimeEntry[]

  // Scanned documents (receipts, etc.)
  scannedDocuments ScannedDocument[]

  @@index([status])
}

model Unit {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId    String    @db.Uuid
  name          String // e.g. 101, 2B, Suite 300
  type          String // room, apartment, office, house
  building      String? // For apartment complexes: Building A, Building B, etc.
  floor         Int? // Floor number for multi-story buildings
  bedrooms      Int?
  bathrooms     Decimal?  @db.Decimal(3, 1)
  sizeSqFt      Int?
  rentAmount    Decimal   @db.Decimal(12, 2)
  isAvailable   Boolean   @default(true)
  availableFrom DateTime?
  images        String[]  @default([])
  amenities     String[]  @default([]) // Unit-specific amenities (in-unit washer/dryer, balcony, etc.)
  createdAt     DateTime  @default(now()) @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt

  property     Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  leases       Lease[]
  tickets      MaintenanceTicket[]
  applications RentalApplication[]

  expenses Expense[]

  leaseViolations LeaseViolation[]

  // Tenant lifecycle relations
  turnoverChecklists UnitTurnoverChecklist[]
  tenantHistory      TenantHistory[]

  // Contractor work orders
  workOrders WorkOrder[]
}

model Lease {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId             String    @db.Uuid
  tenantId           String    @db.Uuid
  legalDocumentId    String?   @db.Uuid // Reference to the lease template used
  startDate          DateTime  @db.Timestamp(6)
  endDate            DateTime? @db.Timestamp(6)
  rentAmount         Decimal   @db.Decimal(12, 2)
  billingDayOfMonth  Int // 1-28 typically
  status             String    @default("active") // active, ended, pending, terminated, pending_signature
  terminationReason  String? // eviction, voluntary, lease_end, mutual_agreement, other
  terminatedAt       DateTime? @db.Timestamp(6)
  docusignEnvelopeId String?
  tenantSignedAt     DateTime? @db.Timestamp(6)
  landlordSignedAt   DateTime? @db.Timestamp(6)
  createdAt          DateTime  @default(now()) @db.Timestamp(6)
  updatedAt          DateTime  @updatedAt

  // Lease template reference and generation metadata
  templateId    String?   @db.Uuid // Reference to LeaseTemplate used
  generatedFrom String? // 'auto' | 'manual' - how the lease was generated
  generatedAt   DateTime? @db.Timestamp(6) // When the lease was generated

  unit          Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant        User           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalDocument LegalDocument? @relation(fields: [legalDocumentId], references: [id], onDelete: SetNull)
  template      LeaseTemplate? @relation("LeaseFromTemplate", fields: [templateId], references: [id], onDelete: SetNull)

  rentPayments      RentPayment[]
  signatureRequests DocumentSignatureRequest[]
  recurringCharges  RecurringCharge[]

  violations LeaseViolation[]

  // Tenant lifecycle relations
  evictionNotices     EvictionNotice[]
  departures          TenantDeparture[]
  depositDispositions DepositDisposition[]

  @@index([templateId])
}

// Model for recurring charges associated with a lease
model RecurringCharge {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId       String    @db.Uuid
  leaseId          String    @db.Uuid
  tenantId         String    @db.Uuid
  description      String // e.g., "Monthly Rent", "Parking Fee"
  amount           Decimal   @db.Decimal(12, 2)
  dayOfMonthToPost Int // 1-31, the day the charge should be posted
  status           String    @default("active") // active, paused, ended
  startDate        DateTime  @db.Date
  endDate          DateTime? @db.Date
  lastPostedDate   DateTime? @db.Date
  nextPostDate     DateTime  @db.Date
  createdAt        DateTime  @default(now()) @db.Timestamp(6)
  updatedAt        DateTime  @updatedAt
  landlord         Landlord  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  lease            Lease     @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenant           User      @relation(fields: [tenantId], references: [id], onDelete: Cascade, map: "recurring_charge_tenant_fk")

  @@index([landlordId, status, nextPostDate])
  @@index([leaseId])
}

model RentPayment {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId               String    @db.Uuid
  tenantId              String    @db.Uuid
  dueDate               DateTime  @db.Timestamp(6)
  paidAt                DateTime? @db.Timestamp(6)
  amount                Decimal   @db.Decimal(12, 2)
  status                String    @default("pending") // pending, processing, paid, failed, overdue
  stripePaymentIntentId String?
  stripeInvoiceId       String?
  paymentMethod         String? // card, us_bank_account, apple_pay, google_pay, link
  convenienceFee        Decimal?  @default(0) @db.Decimal(12, 2)
  isRecurring           Boolean   @default(false)
  metadata              Json?     @db.Json
  walletCredited        Boolean   @default(false) // Has this payment been credited to landlord wallet?
  walletCreditedAt      DateTime? @db.Timestamp(6)
  createdAt             DateTime  @default(now()) @db.Timestamp(6)
  updatedAt             DateTime  @updatedAt

  payoutId String? @db.Uuid

  lease  Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenant User  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  payout Payout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  // For Partial Payments
  amountPaid   Decimal              @default(0) @db.Decimal(12, 2)
  transactions PaymentTransaction[]
}

model PaymentTransaction {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rentPaymentId String   @db.Uuid
  amount        Decimal  @db.Decimal(12, 2)
  status        String // "succeeded", "failed", "pending"
  method        String? // "card", "ach", "cash"
  referenceId   String? // e.g., Stripe charge ID
  processedAt   DateTime @default(now())

  rentPayment RentPayment @relation(fields: [rentPaymentId], references: [id], onDelete: Cascade)

  @@index([rentPaymentId])
}

model Payout {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId       String    @db.Uuid
  amount           Decimal   @db.Decimal(12, 2)
  status           String    @default("pending") // pending, processing, paid, failed
  initiatedAt      DateTime  @default(now()) @db.Timestamp(6)
  paidAt           DateTime? @db.Timestamp(6)
  stripeTransferId String?
  metadata         Json?     @db.Json

  landlord     Landlord      @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  rentPayments RentPayment[]
  platformFees PlatformFee[]

  @@index([landlordId])
}

model PlatformFee {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  payoutId   String   @db.Uuid
  landlordId String   @db.Uuid
  amount     Decimal  @db.Decimal(12, 2)
  type       String   @default("instant_payout_fee") // e.g. instant_payout_fee
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  metadata   Json?    @db.Json

  payout   Payout   @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([payoutId])
}

model MaintenanceTicket {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId         String?   @db.Uuid
  tenantId       String?   @db.Uuid
  title          String
  description    String
  status         String    @default("open") // open, in_progress, resolved, closed
  priority       String    @default("medium") // low, medium, high, urgent
  assignedToName String?
  cost           Decimal?  @db.Decimal(12, 2)
  isRecurring    Boolean   @default(false)
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt
  resolvedAt     DateTime? @db.Timestamp(6)

  unit   Unit? @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tenant User? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  // Contractor work orders linked to this ticket
  workOrders WorkOrder[]
}

model Expense {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId  String   @db.Uuid
  propertyId  String?  @db.Uuid
  unitId      String?  @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  category    String
  description String?
  incurredAt  DateTime @db.Timestamp(6)
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  landlord Landlord  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     Unit?     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([propertyId])
  @@index([unitId])
  @@index([incurredAt])
  @@index([category])
}

model MarketBenchmark {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String   @db.Uuid
  propertyId    String?  @db.Uuid
  zip           String?
  propertyType  String?
  bedrooms      Int?
  averageRent   Decimal  @db.Decimal(12, 2)
  source        String? // manual, zillow, rentometer, etc.
  effectiveDate DateTime @db.Timestamp(6)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  landlord Landlord  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([propertyId])
  @@index([effectiveDate])
}

model PropertyFinance {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId              String   @unique @db.Uuid
  purchasePrice           Decimal? @db.Decimal(12, 2)
  downPayment             Decimal? @db.Decimal(12, 2)
  loanBalance             Decimal? @db.Decimal(12, 2)
  interestRatePercent     Decimal? @db.Decimal(6, 3)
  loanTermMonths          Int?
  annualPropertyTax       Decimal? @db.Decimal(12, 2)
  annualInsurance         Decimal? @db.Decimal(12, 2)
  hoaMonthly              Decimal? @db.Decimal(12, 2)
  managementFeePercent    Decimal? @db.Decimal(6, 3)
  appreciationRatePercent Decimal? @db.Decimal(6, 3)
  createdAt               DateTime @default(now()) @db.Timestamp(6)
  updatedAt               DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model LeaseViolation {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId  String    @db.Uuid
  leaseId     String    @db.Uuid
  tenantId    String?   @db.Uuid
  unitId      String?   @db.Uuid
  type        String
  description String?
  occurredAt  DateTime  @db.Timestamp(6)
  resolvedAt  DateTime? @db.Timestamp(6)
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime  @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  lease    Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenant   User?    @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  unit     Unit?    @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([leaseId])
  @@index([tenantId])
  @@index([unitId])
  @@index([occurredAt])
  @@index([type])
}

model RentalApplication {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId               String?   @db.Uuid
  applicantId          String?   @db.Uuid
  fullName             String
  email                String
  phone                String?
  moveInDate           DateTime? @db.Timestamp(6)
  monthlyIncome        Decimal?  @db.Decimal(12, 2)
  employmentStatus     String?
  notes                String?
  adminResponse        String?
  propertySlug         String?
  encryptedSsn         String? // Encrypted SSN - never store in plain text
  status               String    @default("pending") // pending, approved, rejected, withdrawn
  screeningProvider    String?
  screeningBundle      String? // e.g. eviction_only, background_only, full_package
  screeningStatus      String? // requested, in_progress, complete, failed
  screeningReportUrl   String?
  screeningRequestedAt DateTime? @db.Timestamp(6)
  screeningCompletedAt DateTime? @db.Timestamp(6)
  createdAt            DateTime  @default(now()) @db.Timestamp(6)
  updatedAt            DateTime  @updatedAt

  unit      Unit? @relation(fields: [unitId], references: [id], onDelete: Cascade)
  applicant User? @relation(fields: [applicantId], references: [id], onDelete: SetNull)

  documents             ApplicationDocument[]
  verificationDocuments VerificationDocument[]
  verification          ApplicationVerification?
}

model ApplicationDocument {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String @db.Uuid
  landlordId    String @db.Uuid
  uploadedById  String @db.Uuid

  category String
  docType  String

  originalFileName String
  mimeType         String
  fileSize         Int

  cloudinaryPublicId     String
  cloudinaryResourceType String @default("raw")
  status                 String @default("uploaded")

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  application RentalApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  landlord    Landlord          @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  uploadedBy  User              @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([landlordId])
  @@index([uploadedById])
  @@index([category])
  @@index([docType])
  @@index([status])
}

model Notification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  type      String // application, message, maintenance, payment, reminder
  title     String
  message   String
  isRead    Boolean  @default(false)
  actionUrl String? // URL to redirect when clicked
  metadata  Json? // Additional data like applicationId, ticketId, etc.
  createdAt DateTime @default(now()) @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model LegalDocument {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId         String   @db.Uuid
  name               String
  type               String // 'lease', 'addendum', 'disclosure', 'notice', 'other'
  category           String? // 'custom', 'state_template'
  state              String? // State code for state-specific templates (e.g., 'NV', 'CA')
  fileUrl            String? // URL to uploaded file (S3/Cloudinary)
  fileType           String? // 'pdf', 'docx', 'doc'
  fileSize           Int? // Size in bytes
  pageCount          Int? // Number of pages in the document
  isTemplate         Boolean  @default(false) // If true, this is a template that can be used for new leases
  isActive           Boolean  @default(true)
  isFieldsConfigured Boolean  @default(false) // True if signature/initial fields have been placed
  description        String?
  docusignTemplateId String? // DocuSign template ID if integrated
  signatureFields    Json? // Array of signature/initial field positions: [{id, type, page, x, y, width, height, role}]
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @updatedAt

  landlord          Landlord                   @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  signatureRequests DocumentSignatureRequest[]
  propertyDefaults  Property[]                 @relation("DefaultLeaseDocument")
  leases            Lease[]

  @@index([landlordId])
  @@index([type])
}

// ============= LEASE TEMPLATES =============

// LeaseTemplate - Reusable lease templates for auto-generation
model LeaseTemplate {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId String  @db.Uuid
  name       String
  type       String // 'builder' | 'uploaded_pdf'
  isDefault  Boolean @default(false)

  // Builder config (JSON) - for type='builder'
  builderConfig Json? @db.Json

  // PDF config - for type='uploaded_pdf'
  pdfUrl          String?
  signatureFields Json?   @db.Json // Array of signature/initial field positions
  mergeFields     Json?   @db.Json // Array of merge field configurations

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  landlord   Landlord                @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  properties PropertyLeaseTemplate[]
  leases     Lease[]                 @relation("LeaseFromTemplate")

  @@index([landlordId])
  @@index([isDefault])
}

// PropertyLeaseTemplate - Junction table for property-specific template assignment
model PropertyLeaseTemplate {
  id              String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId      String @db.Uuid
  leaseTemplateId String @db.Uuid

  createdAt DateTime @default(now()) @db.Timestamp(6)

  property      Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  leaseTemplate LeaseTemplate @relation(fields: [leaseTemplateId], references: [id], onDelete: Cascade)

  @@unique([propertyId]) // One template per property
  @@index([leaseTemplateId])
}

model DocumentSignatureRequest {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId         String    @db.Uuid
  leaseId            String?   @db.Uuid
  recipientEmail     String
  recipientName      String
  status             String    @default("pending") // 'pending', 'sent', 'viewed', 'signed', 'declined', 'expired'
  docusignEnvelopeId String? // DocuSign envelope ID
  signedAt           DateTime?
  expiresAt          DateTime?
  token              String?   @unique
  signerName         String?
  signerEmail        String?
  signerIp           String?
  signerUserAgent    String?
  signedPdfUrl       String?
  auditLogUrl        String?
  documentHash       String?
  role               String    @default("tenant") // tenant, landlord
  createdAt          DateTime  @default(now()) @db.Timestamp(6)
  updatedAt          DateTime  @updatedAt

  // Signature and initials data (base64 data URLs)
  signatureDataUrl String? @db.Text // Base64 signature image
  initialsDataUrl  String? @db.Text // Base64 initials image

  // Progress tracking for signing wizard
  fieldSectionContext Json?     @db.Json // { fieldId: "Section Name" } - section context for each field
  completedFieldIds   String[]  @default([]) // Array of completed field IDs
  lastProgressAt      DateTime? @db.Timestamp(6) // Last time progress was saved

  document LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  lease    Lease?        @relation(fields: [leaseId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([leaseId])
  @@index([status])
  @@index([token])
  @@index([role])
}

model PropertyInspection {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId  String    @db.Uuid
  inspectorId String?   @db.Uuid
  unitId      String?   @db.Uuid
  status      String    @default("in_progress") // in_progress, completed, cancelled
  location    Json?     @db.Json // { lat, lng }
  summary     Json?     @db.Json // { total, passed, failed, warnings }
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  completedAt DateTime? @db.Timestamp(6)
  updatedAt   DateTime  @updatedAt

  property Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items    InspectionItem[]

  @@index([propertyId])
  @@index([status])
}

model InspectionItem {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inspectionId String   @db.Uuid
  category     String // exterior, interior, kitchen, bathroom, safety
  item         String
  status       String // pass, fail, warning
  notes        String?
  photos       String[] @default([])
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  inspection PropertyInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
}

model PropertySchedule {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId   String   @db.Uuid
  schedule     Json     @db.Json // { monday: { enabled: true, slots: [{start: "09:00", end: "17:00"}] }, ... }
  timezone     String   @default("America/Los_Angeles")
  slotDuration Int      @default(30) // minutes
  bufferTime   Int      @default(0) // minutes between appointments
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId])
  @@index([propertyId])
}

model PropertyAppointment {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId String   @db.Uuid
  scheduleId String?  @db.Uuid
  name       String
  email      String
  phone      String?
  date       DateTime @db.Timestamp(6)
  startTime  String // "09:00"
  endTime    String // "09:30"
  status     String   @default("pending") // pending, confirmed, cancelled, completed
  notes      String?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([date])
  @@index([status])
}

model ScannedDocument {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId       String    @db.Uuid
  uploadedBy       String?   @db.Uuid
  propertyId       String?   @db.Uuid // Property this document belongs to
  originalFileName String
  fileUrl          String // S3/Cloudinary URL
  fileType         String // pdf, jpg, png, etc
  fileSize         Int // bytes
  ocrText          String? // Extracted text from OCR
  ocrConfidence    Decimal?  @db.Decimal(5, 2) // 0-100 confidence score
  ocrProcessedAt   DateTime? @db.Timestamp(6)

  // Classification
  documentType         String? // lease, receipt, application, notice, other
  classificationStatus String    @default("pending") // pending, classified, manual_review
  classifiedAt         DateTime? @db.Timestamp(6)

  // Extracted metadata (AI/manual)
  extractedData Json? @db.Json // Flexible field for extracted info

  // Conversion status
  conversionStatus     String  @default("pending") // pending, in_progress, completed, failed, skipped
  convertedToLeaseId   String? @db.Uuid
  convertedToPaymentId String? @db.Uuid
  convertedToTenantId  String? @db.Uuid
  convertedToExpenseId String? @db.Uuid // Link to created expense

  notes     String?
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  landlord Landlord  @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  uploader User?     @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([propertyId])
  @@index([documentType])
  @@index([classificationStatus])
  @@index([conversionStatus])
  @@index([createdAt])
}

model DocumentClassificationRule {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId   String?  @db.Uuid // null = global rule
  documentType String // lease, receipt, application, etc
  keywords     String[] @default([]) // Keywords to match
  patterns     String[] @default([]) // Regex patterns
  priority     Int      @default(0) // Higher priority rules checked first
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  landlord Landlord? @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([documentType])
}

model LandlordSubscription {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId           String    @unique @db.Uuid
  tier                 String    @default("free") // free, growth, professional, enterprise
  stripeSubscriptionId String?   @unique
  stripeCustomerId     String?
  stripePriceId        String?
  status               String    @default("active") // active, past_due, canceled, trialing, incomplete
  currentPeriodStart   DateTime? @db.Timestamp(6)
  currentPeriodEnd     DateTime? @db.Timestamp(6)
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime? @db.Timestamp(6)
  trialEnd             DateTime? @db.Timestamp(6)

  // Tier limits
  unitLimit Int @default(24) // Free tier: 24 units

  // Perks
  freeBackgroundChecks       Boolean @default(false)
  freeEvictionChecks         Boolean @default(false)
  freeEmploymentVerification Boolean @default(false)

  // Granted subscriptions (by super admin)
  isGranted Boolean   @default(false)
  grantedBy String?   @db.Uuid // User ID of super admin who granted
  grantedAt DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([tier])
  @@index([isGranted])
}

model SubscriptionEvent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String   @db.Uuid
  eventType     String // upgrade, downgrade, canceled, payment_failed, renewed
  fromTier      String?
  toTier        String?
  amount        Decimal? @db.Decimal(12, 2)
  stripeEventId String?  @unique
  metadata      Json?    @db.Json
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  @@index([landlordId])
  @@index([eventType])
  @@index([createdAt])
}

// Employment verification tracking for subscription limits
model EmploymentCheck {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String   @db.Uuid
  applicationId String   @db.Uuid
  status        String   @default("pending") // pending, completed, failed
  result        Json?    @db.Json
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  @@index([landlordId])
  @@index([applicationId])
  @@index([createdAt])
}

// Team management for Professional tier
model TeamMember {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String    @db.Uuid
  userId        String?   @db.Uuid
  role          String    @default("member") // owner, admin, member
  permissions   String[]  @default([]) // view_properties, manage_tenants, manage_maintenance, manage_finances
  invitedEmail  String?
  inviteToken   String?   @unique
  inviteExpires DateTime? @db.Timestamp(6)
  status        String    @default("pending") // pending, active, inactive
  joinedAt      DateTime? @db.Timestamp(6)
  createdAt     DateTime  @default(now()) @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt

  landlord        Landlord                 @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  user            User?                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  compensation    TeamMemberCompensation?
  availability    TeamMemberAvailability[]
  timeOffRequests TimeOffRequest[]
  shifts          Shift[]
  timeEntries     TimeEntry[]
  timesheets      Timesheet[]
  teamPayments    TeamPayment[]

  @@unique([landlordId, invitedEmail])
  @@index([landlordId])
  @@index([userId])
  @@index([inviteToken])
}

// Team communication channels (Slack-like)
model TeamChannel {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId  String   @db.Uuid
  name        String
  description String?
  type        String   @default("public") // public, private, direct
  createdById String   @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  messages TeamMessage[]
  members  TeamChannelMember[]

  @@index([landlordId])
}

model TeamChannelMember {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId  String    @db.Uuid
  userId     String    @db.Uuid
  role       String    @default("member") // admin, member
  lastReadAt DateTime? @db.Timestamp(6)
  joinedAt   DateTime  @default(now()) @db.Timestamp(6)

  channel TeamChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
}

model TeamMessage {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId   String    @db.Uuid
  senderId    String    @db.Uuid
  content     String
  attachments String[]  @default([])
  isEdited    Boolean   @default(false)
  editedAt    DateTime? @db.Timestamp(6)
  createdAt   DateTime  @default(now()) @db.Timestamp(6)

  channel TeamChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([senderId])
  @@index([createdAt])
}

// Automatic rent reminder settings
model RentReminderSettings {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId         String   @unique @db.Uuid
  enabled            Boolean  @default(false)
  reminderDaysBefore Int[]    @default([7, 3, 1]) // Days before due date to send reminders
  reminderChannels   String[] @default(["email"]) // email, sms, push
  customMessage      String?
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @updatedAt

  @@index([landlordId])
}

// Automatic late fee settings
model LateFeeSettings {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId        String   @unique @db.Uuid
  enabled           Boolean  @default(false)
  gracePeriodDays   Int      @default(5) // Days after due date before late fee applies
  feeType           String   @default("flat") // flat, percentage
  feeAmount         Decimal  @db.Decimal(12, 2) // Flat amount or percentage
  maxFee            Decimal? @db.Decimal(12, 2) // Maximum late fee cap
  recurringFee      Boolean  @default(false) // Apply fee daily/weekly after grace period
  recurringInterval String? // daily, weekly
  notifyTenant      Boolean  @default(true)
  createdAt         DateTime @default(now()) @db.Timestamp(6)
  updatedAt         DateTime @updatedAt

  @@index([landlordId])
}

// Blocked IP addresses for security
model BlockedIP {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ipAddress String    @unique
  reason    String?
  blockedBy String?   @db.Uuid
  expiresAt DateTime? @db.Timestamp(6) // null = permanent
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  updatedAt DateTime  @updatedAt

  @@index([ipAddress])
  @@index([expiresAt])
}

// Tenant Verification System Models

// Verification document model - stores all uploaded verification documents
model VerificationDocument {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String @db.Uuid
  landlordId    String @db.Uuid
  uploadedById  String @db.Uuid

  // Document classification
  category String // 'identity' or 'employment'
  docType  String // 'drivers_license', 'state_id', 'pay_stub', 'bank_statement', 'tax_document'

  // File metadata
  originalFileName       String
  mimeType               String
  fileSize               Int
  cloudinaryPublicId     String
  cloudinaryResourceType String @default("raw")
  cloudinarySecureUrl    String

  // OCR results
  ocrText        String?
  ocrConfidence  Decimal?  @db.Decimal(5, 2) // 0-100
  ocrProcessedAt DateTime? @db.Timestamp(6)
  extractedData  Json?     @db.Json // Structured data extracted from document

  // Verification status
  verificationStatus      String    @default("pending") // pending, processing, verified, rejected, needs_review
  verificationMethod      String? // 'ocr', 'stripe_identity', 'manual'
  verificationCompletedAt DateTime? @db.Timestamp(6)

  // Fraud detection
  fraudScore      Decimal? @db.Decimal(5, 2) // 0-100, higher = more suspicious
  fraudIndicators String[] @default([])

  // Rejection/review
  rejectionReason String?
  reviewNotes     String?
  reviewedBy      String?   @db.Uuid
  reviewedAt      DateTime? @db.Timestamp(6)

  // Expiration
  expiresAt              DateTime? @db.Timestamp(6) // Document expiration (e.g., ID expiry)
  dataRetentionExpiresAt DateTime  @db.Timestamp(6) // Auto-delete after 90 days

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  application RentalApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  landlord    Landlord          @relation("VerificationDocuments", fields: [landlordId], references: [id], onDelete: Cascade)
  uploadedBy  User              @relation("UploadedVerificationDocs", fields: [uploadedById], references: [id], onDelete: Cascade)
  reviewer    User?             @relation("ReviewedVerificationDocs", fields: [reviewedBy], references: [id], onDelete: SetNull)

  fraudLogs FraudDetectionLog[]

  @@index([applicationId])
  @@index([landlordId])
  @@index([uploadedById])
  @@index([category])
  @@index([docType])
  @@index([verificationStatus])
  @@index([dataRetentionExpiresAt])
}

// Verification summary for each application
model ApplicationVerification {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String @unique @db.Uuid

  // Identity verification
  identityStatus     String    @default("pending") // pending, verified, rejected, needs_review
  identityVerifiedAt DateTime? @db.Timestamp(6)
  identityDocumentId String?   @db.Uuid

  // Employment verification
  employmentStatus         String    @default("pending") // pending, verified, rejected, needs_review
  employmentVerifiedAt     DateTime? @db.Timestamp(6)
  monthlyIncome            Decimal?  @db.Decimal(12, 2)
  incomeVerificationMethod String? // 'ocr', 'plaid', 'manual'

  // Overall status
  overallStatus String    @default("incomplete") // incomplete, complete, expired
  completedAt   DateTime? @db.Timestamp(6)
  expiresAt     DateTime? @db.Timestamp(6) // 90 days from completion

  // Third-party integration tracking
  stripeIdentitySessionId String?
  plaidLinkToken          String?
  plaidAccessToken        String? // Encrypted

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  application RentalApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([identityStatus])
  @@index([employmentStatus])
  @@index([overallStatus])
}

// Employment verification usage tracking (for subscription limits)
model EmploymentVerificationUsage {
  id                     String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId             String  @db.Uuid
  applicationId          String  @db.Uuid
  verificationDocumentId String? @db.Uuid

  method             String // 'ocr', 'plaid', 'truework', 'manual'
  cost               Decimal  @db.Decimal(10, 2) // $0 for free checks, $5 for paid
  wasFree            Boolean  @default(false)
  billingPeriodStart DateTime @db.Timestamp(6)
  billingPeriodEnd   DateTime @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)

  landlord Landlord @relation("EmploymentVerificationUsage", fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([applicationId])
  @@index([billingPeriodStart, billingPeriodEnd])
  @@index([createdAt])
}

// Fraud detection audit log
model FraudDetectionLog {
  id                     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  verificationDocumentId String @db.Uuid

  checkType String // 'image_manipulation', 'format_validation', 'expiration_check', etc.
  result    String // 'pass', 'fail', 'warning'
  score     Decimal? @db.Decimal(5, 2)
  details   Json?    @db.Json

  createdAt DateTime @default(now()) @db.Timestamp(6)

  verificationDocument VerificationDocument @relation(fields: [verificationDocumentId], references: [id], onDelete: Cascade)

  @@index([verificationDocumentId])
  @@index([checkType])
  @@index([result])
}

// Document access audit log
model DocumentAccessLog {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  verificationDocumentId String   @db.Uuid
  userId                 String   @db.Uuid
  accessType             String // 'view', 'download', 'review'
  purpose                String? // 'tenant_view', 'landlord_review', 'admin_audit', etc.
  ipAddress              String?
  userAgent              String?
  createdAt              DateTime @default(now()) @db.Timestamp(6)

  @@index([verificationDocumentId])
  @@index([userId])
  @@index([createdAt])
}

// Property-specific bank account for separate cashouts per property
model PropertyBankAccount {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId            String   @unique @db.Uuid
  stripePaymentMethodId String
  accountHolderName     String
  last4                 String
  bankName              String?
  accountType           String? // 'checking' or 'savings'
  routingNumber         String?
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([stripePaymentMethodId])
}

// Tenant invoices for custom charges (repairs, violations, etc.)
model TenantInvoice {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId            String    @db.Uuid
  tenantId              String    @db.Uuid
  leaseId               String?   @db.Uuid
  amount                Decimal   @db.Decimal(12, 2)
  reason                String // e.g. "Repair charge", "Late fee", "Pet violation", etc.
  description           String? // Detailed description
  dueDate               DateTime  @db.Timestamp(6)
  status                String    @default("pending") // pending, paid, overdue, cancelled
  paidAt                DateTime? @db.Timestamp(6)
  stripePaymentIntentId String?
  paymentMethod         String?
  createdAt             DateTime  @default(now()) @db.Timestamp(6)
  updatedAt             DateTime  @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant   User     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([tenantId])
  @@index([leaseId])
  @@index([status])
  @@index([dueDate])
}

// ============= LANDLORD WALLET SYSTEM =============

// Landlord wallet for tracking available balance from rent payments
model LandlordWallet {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId       String    @unique @db.Uuid
  availableBalance Decimal   @default(0) @db.Decimal(12, 2) // Ready to cash out
  pendingBalance   Decimal   @default(0) @db.Decimal(12, 2) // Processing (7-day hold)
  lastPayoutAt     DateTime? @db.Timestamp(6)
  createdAt        DateTime  @default(now()) @db.Timestamp(6)
  updatedAt        DateTime  @updatedAt

  landlord     Landlord            @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([landlordId])
}

// Wallet transaction history
model WalletTransaction {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId    String    @db.Uuid
  type        String // 'credit' (rent received), 'payout' (cash out), 'fee', 'refund', 'contractor_payment'
  amount      Decimal   @db.Decimal(12, 2) // Positive for credits, negative for debits
  description String?
  status      String    @default("completed") // pending, completed, failed
  referenceId String?   @db.Uuid // Link to RentPayment, Payout, etc.
  metadata    Json?     @db.Json
  availableAt DateTime? @db.Timestamp(6) // When funds become available (after Stripe hold)
  createdAt   DateTime  @default(now()) @db.Timestamp(6)

  wallet LandlordWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@index([availableAt])
  @@index([status])
}

// ============= TENANT LIFECYCLE MANAGEMENT =============

// Eviction notice tracking
model EvictionNotice {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId    String @db.Uuid
  tenantId   String @db.Uuid
  landlordId String @db.Uuid
  unitId     String @db.Uuid

  noticeType      String // '3-day', '7-day', '30-day'
  status          String   @default("served") // served, cure_period, cured, expired, filed_with_court, completed
  reason          String
  amountOwed      Decimal? @db.Decimal(12, 2)
  additionalNotes String?

  servedAt     DateTime  @default(now()) @db.Timestamp(6)
  deadlineDate DateTime  @db.Timestamp(6)
  curedAt      DateTime? @db.Timestamp(6)
  filedAt      DateTime? @db.Timestamp(6)
  completedAt  DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([leaseId])
  @@index([tenantId])
  @@index([landlordId])
  @@index([status])
}

// Tenant departure records
model TenantDeparture {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId    String @db.Uuid
  tenantId   String @db.Uuid
  unitId     String @db.Uuid
  landlordId String @db.Uuid

  departureType String // 'eviction', 'voluntary', 'lease_end', 'mutual_agreement'
  departureDate DateTime @db.Timestamp(6)
  notes         String?

  // Linked eviction notice if departure was due to eviction
  evictionNoticeId String? @db.Uuid

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([leaseId])
  @@index([tenantId])
  @@index([unitId])
}

// Security deposit disposition
model DepositDisposition {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId    String @db.Uuid
  tenantId   String @db.Uuid
  landlordId String @db.Uuid

  originalAmount  Decimal @db.Decimal(12, 2)
  totalDeductions Decimal @db.Decimal(12, 2)
  refundAmount    Decimal @db.Decimal(12, 2)
  refundMethod    String? // 'check', 'ach', 'pending'
  refundStatus    String  @default("pending") // 'pending', 'processing', 'completed'

  notes       String?
  processedAt DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  lease      Lease                  @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  deductions DepositDeductionItem[]

  @@index([leaseId])
  @@index([tenantId])
}

// Itemized deposit deductions with evidence
model DepositDeductionItem {
  id                   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  depositDispositionId String @db.Uuid

  category     String // 'damages', 'unpaid_rent', 'cleaning', 'repairs', 'other'
  amount       Decimal  @db.Decimal(12, 2)
  description  String
  evidenceUrls String[] @default([]) // Cloudinary URLs for photos/videos

  createdAt DateTime @default(now()) @db.Timestamp(6)

  depositDisposition DepositDisposition @relation(fields: [depositDispositionId], references: [id], onDelete: Cascade)

  @@index([depositDispositionId])
}

// Unit turnover checklist for preparing unit for new tenant
model UnitTurnoverChecklist {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId     String  @db.Uuid
  leaseId    String? @db.Uuid // The lease that ended
  landlordId String  @db.Uuid

  depositProcessed  Boolean @default(false)
  keysCollected     Boolean @default(false)
  unitInspected     Boolean @default(false)
  cleaningCompleted Boolean @default(false)
  repairsCompleted  Boolean @default(false)

  depositProcessedAt  DateTime? @db.Timestamp(6)
  keysCollectedAt     DateTime? @db.Timestamp(6)
  unitInspectedAt     DateTime? @db.Timestamp(6)
  cleaningCompletedAt DateTime? @db.Timestamp(6)
  repairsCompletedAt  DateTime? @db.Timestamp(6)

  notes       String?
  completedAt DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([landlordId])
}

// Historical record of past tenants
model TenantHistory {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId     String @db.Uuid
  propertyId String @db.Uuid
  landlordId String @db.Uuid
  tenantId   String @db.Uuid
  leaseId    String @db.Uuid

  tenantName  String
  tenantEmail String
  tenantPhone String?

  leaseStartDate DateTime  @db.Timestamp(6)
  leaseEndDate   DateTime? @db.Timestamp(6)
  rentAmount     Decimal   @db.Decimal(12, 2)

  departureType  String // 'eviction', 'voluntary', 'lease_end', 'mutual_agreement'
  departureDate  DateTime @db.Timestamp(6)
  departureNotes String?

  // Deposit summary
  depositAmount   Decimal? @db.Decimal(12, 2)
  depositRefunded Decimal? @db.Decimal(12, 2)
  depositDeducted Decimal? @db.Decimal(12, 2)

  // Eviction info if applicable
  wasEvicted     Boolean @default(false)
  evictionReason String?

  createdAt DateTime @default(now()) @db.Timestamp(6)

  unit     Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([propertyId])
  @@index([landlordId])
  @@index([tenantId])
  @@index([departureDate])
}

// ============= CONTRACTOR MANAGEMENT SYSTEM =============

// Contractor - A service provider in a landlord's directory
model Contractor {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId             String   @db.Uuid
  userId                 String?  @db.Uuid
  name                   String
  email                  String
  phone                  String?
  specialties            String[] @default([])
  stripeConnectAccountId String? // @deprecated - no longer used
  stripeOnboardingStatus String? // @deprecated - no longer used
  isPaymentReady         Boolean  @default(false)
  notes                  String?

  // Bank account for receiving payments (platform-held model)
  stripeCustomerId    String? // Stripe customer ID for this contractor
  stripeBankAccountId String? // Bank account ID attached to customer
  bankAccountLast4    String? // Last 4 digits for display
  bankName            String? // Bank name for display
  businessName        String? // Business name (if different from contact name)
  contactName         String? // Contact person name

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  landlord   Landlord             @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  user       User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  invites    ContractorInvite[]
  workOrders WorkOrder[]
  payments   ContractorPayment[]
  estimates  ContractorEstimate[]
  bids       WorkOrderBid[]

  @@unique([landlordId, email])
  @@index([landlordId])
  @@index([userId])
}

// ContractorEstimate - Quotes and estimate templates
model ContractorEstimate {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorId   String    @db.Uuid
  landlordId     String?   @db.Uuid
  workOrderId    String?   @db.Uuid
  title          String
  description    String?
  lineItems      Json      @default("[]") @db.Json // [{description, qty, unitPrice, total}]
  laborCost      Decimal   @default(0) @db.Decimal(12, 2)
  materialsCost  Decimal   @default(0) @db.Decimal(12, 2)
  totalAmount    Decimal   @db.Decimal(12, 2)
  estimatedHours Decimal?  @db.Decimal(6, 2)
  validUntil     DateTime? @db.Timestamp(6)
  status         String    @default("draft") // draft, sent, viewed, accepted, declined, expired
  isTemplate     Boolean   @default(false)
  templateName   String?
  attachmentUrl  String? // PDF upload of their standard estimate form
  sentAt         DateTime? @db.Timestamp(6)
  viewedAt       DateTime? @db.Timestamp(6)
  respondedAt    DateTime? @db.Timestamp(6)
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt

  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  landlord   Landlord?  @relation(fields: [landlordId], references: [id], onDelete: SetNull)
  workOrder  WorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  @@index([contractorId])
  @@index([landlordId])
  @@index([status])
  @@index([isTemplate])
}

// ContractorInvite - Pending invitation to join platform
model ContractorInvite {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId   String   @db.Uuid
  contractorId String   @db.Uuid
  email        String
  token        String   @unique
  status       String   @default("pending") // pending, accepted, expired
  expiresAt    DateTime @db.Timestamp(6)
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  landlord   Landlord   @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([landlordId])
}

// WorkOrderBid - Contractor bids on open job postings (Upwork-style)
model WorkOrderBid {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workOrderId       String    @db.Uuid
  contractorId      String    @db.Uuid
  amount            Decimal   @db.Decimal(12, 2)
  estimatedHours    Decimal?  @db.Decimal(6, 2)
  proposedStartDate DateTime? @db.Timestamp(6)
  message           String?
  status            String    @default("pending") // pending, accepted, declined, withdrawn
  createdAt         DateTime  @default(now()) @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt

  workOrder  WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([workOrderId, contractorId])
  @@index([workOrderId])
  @@index([contractorId])
}

// WorkOrder - Assignment of work to a contractor
model WorkOrder {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId          String    @db.Uuid
  contractorId        String?   @db.Uuid // Nullable for open bid jobs
  maintenanceTicketId String?   @db.Uuid
  propertyId          String    @db.Uuid
  unitId              String?   @db.Uuid
  title               String
  description         String
  status              String    @default("draft") // draft, open, assigned, in_progress, completed, approved, paid, cancelled, disputed
  priority            String    @default("medium") // low, medium, high, urgent
  agreedPrice         Decimal?  @db.Decimal(12, 2) // Nullable for open bid jobs
  actualCost          Decimal?  @db.Decimal(12, 2)
  scheduledDate       DateTime? @db.Timestamp(6)
  completedAt         DateTime? @db.Timestamp(6)
  notes               String?

  // Escrow fields (Upwork-style)
  escrowStatus          String    @default("none") // none, funded, released, refunded, disputed
  escrowAmount          Decimal?  @db.Decimal(12, 2)
  escrowFundedAt        DateTime? @db.Timestamp(6)
  escrowReleasedAt      DateTime? @db.Timestamp(6)
  stripePaymentIntentId String?

  // Open bid fields
  isOpenBid   Boolean   @default(false)
  bidDeadline DateTime? @db.Timestamp(6)
  budgetMin   Decimal?  @db.Decimal(12, 2)
  budgetMax   Decimal?  @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  landlord          Landlord             @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  contractor        Contractor?          @relation(fields: [contractorId], references: [id], onDelete: SetNull)
  maintenanceTicket MaintenanceTicket?   @relation(fields: [maintenanceTicketId], references: [id], onDelete: SetNull)
  property          Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit              Unit?                @relation(fields: [unitId], references: [id], onDelete: SetNull)
  media             WorkOrderMedia[]
  history           WorkOrderHistory[]
  payment           ContractorPayment?
  bids              WorkOrderBid[]
  estimates         ContractorEstimate[]

  @@index([landlordId])
  @@index([contractorId])
  @@index([status])
  @@index([propertyId])
  @@index([isOpenBid])
}

// WorkOrderMedia - Photos/videos attached to work orders
model WorkOrderMedia {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workOrderId  String   @db.Uuid
  uploadedById String   @db.Uuid
  uploaderRole String // landlord, contractor
  type         String // image, video
  url          String
  thumbnailUrl String?
  caption      String?
  phase        String   @default("before") // before, during, after
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  uploader  User      @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([workOrderId])
}

// WorkOrderHistory - Audit trail of status changes
model WorkOrderHistory {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workOrderId    String   @db.Uuid
  changedById    String   @db.Uuid
  previousStatus String
  newStatus      String
  notes          String?
  createdAt      DateTime @default(now()) @db.Timestamp(6)

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  changedBy User      @relation(fields: [changedById], references: [id], onDelete: Cascade)

  @@index([workOrderId])
}

// ContractorPayment - Payment record
model ContractorPayment {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId       String    @db.Uuid
  contractorId     String    @db.Uuid
  workOrderId      String?   @unique @db.Uuid // Optional - can pay without work order, unique for 1:1 relation
  amount           Decimal   @db.Decimal(12, 2)
  platformFee      Decimal?  @db.Decimal(12, 2)
  netAmount        Decimal?  @db.Decimal(12, 2)
  status           String    @default("pending") // pending, processing, paid, failed
  stripeTransferId String? // @deprecated
  stripePayoutId   String? // New: Payout ID from platform account
  description      String?
  failureReason    String?
  paidAt           DateTime? @db.Timestamp(6)
  metadata         Json?     @db.Json
  createdAt        DateTime  @default(now()) @db.Timestamp(6)

  landlord   Landlord   @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  workOrder  WorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([contractorId])
  @@index([status])
}

// ============= TEAM OPERATIONS (ENTERPRISE) =============

// Team member compensation settings
model TeamMemberCompensation {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamMemberId           String   @unique @db.Uuid
  payType                String   @default("hourly") // hourly, salary
  hourlyRate             Decimal? @db.Decimal(10, 2)
  salaryAmount           Decimal? @db.Decimal(12, 2) // Annual salary
  overtimeRate           Decimal? @db.Decimal(10, 2) // Defaults to 1.5x hourly
  commissionRate         Decimal? @db.Decimal(5, 2) // Percentage for leasing agents
  stripeAccountId        String?
  stripeOnboardingStatus String?  @default("pending")
  isPaymentReady         Boolean  @default(false)
  createdAt              DateTime @default(now()) @db.Timestamp(6)
  updatedAt              DateTime @updatedAt

  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@index([teamMemberId])
}

// Team member availability (recurring weekly schedule)
model TeamMemberAvailability {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamMemberId String   @db.Uuid
  dayOfWeek    Int // 0=Sunday, 1=Monday, etc.
  startTime    String // "09:00" format
  endTime      String // "17:00" format
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, dayOfWeek])
  @@index([teamMemberId])
}

// Time off requests
model TimeOffRequest {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  teamMemberId String    @db.Uuid
  landlordId   String    @db.Uuid
  startDate    DateTime  @db.Date
  endDate      DateTime  @db.Date
  reason       String?
  status       String    @default("pending") // pending, approved, denied
  reviewedById String?   @db.Uuid
  reviewedAt   DateTime? @db.Timestamp(6)
  reviewNotes  String?
  createdAt    DateTime  @default(now()) @db.Timestamp(6)

  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  landlord   Landlord   @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  reviewedBy User?      @relation("TimeOffReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@index([teamMemberId])
  @@index([landlordId])
  @@index([status])
}

// Scheduled shifts
model Shift {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId   String   @db.Uuid
  teamMemberId String   @db.Uuid
  propertyId   String?  @db.Uuid
  date         DateTime @db.Date
  startTime    String // "09:00" format
  endTime      String // "17:00" format
  notes        String?
  status       String   @default("scheduled") // scheduled, completed, missed, cancelled
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  landlord    Landlord    @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  teamMember  TeamMember  @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  property    Property?   @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  timeEntries TimeEntry[]

  @@index([landlordId])
  @@index([teamMemberId])
  @@index([date])
  @@index([propertyId])
}

// Time entries (clock in/out records)
model TimeEntry {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId     String    @db.Uuid
  teamMemberId   String    @db.Uuid
  shiftId        String?   @db.Uuid
  propertyId     String?   @db.Uuid
  clockIn        DateTime  @db.Timestamp(6)
  clockOut       DateTime? @db.Timestamp(6)
  clockInLat     Decimal?  @db.Decimal(10, 7)
  clockInLng     Decimal?  @db.Decimal(10, 7)
  clockOutLat    Decimal?  @db.Decimal(10, 7)
  clockOutLng    Decimal?  @db.Decimal(10, 7)
  breakMinutes   Int       @default(0)
  totalMinutes   Int?
  notes          String?
  isManual       Boolean   @default(false)
  approvalStatus String    @default("pending") // pending, approved, rejected
  timesheetId    String?   @db.Uuid
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt

  landlord   Landlord   @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  shift      Shift?     @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  property   Property?  @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  timesheet  Timesheet? @relation(fields: [timesheetId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([teamMemberId])
  @@index([clockIn])
  @@index([timesheetId])
}

// Pay periods and timesheets
model Timesheet {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String    @db.Uuid
  teamMemberId  String    @db.Uuid
  periodStart   DateTime  @db.Date
  periodEnd     DateTime  @db.Date
  totalHours    Decimal   @default(0) @db.Decimal(10, 2)
  regularHours  Decimal   @default(0) @db.Decimal(10, 2)
  overtimeHours Decimal   @default(0) @db.Decimal(10, 2)
  status        String    @default("draft") // draft, submitted, approved, rejected, paid
  submittedAt   DateTime? @db.Timestamp(6)
  reviewedById  String?   @db.Uuid
  reviewedAt    DateTime? @db.Timestamp(6)
  reviewNotes   String?
  createdAt     DateTime  @default(now()) @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt

  landlord    Landlord     @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  teamMember  TeamMember   @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  reviewedBy  User?        @relation("TimesheetReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  timeEntries TimeEntry[]
  payment     TeamPayment?

  @@unique([teamMemberId, periodStart, periodEnd])
  @@index([landlordId])
  @@index([teamMemberId])
  @@index([status])
}

// Team payroll payments
model TeamPayment {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId       String    @db.Uuid
  teamMemberId     String    @db.Uuid
  timesheetId      String?   @unique @db.Uuid
  paymentType      String    @default("timesheet") // timesheet, bonus, commission, adjustment
  grossAmount      Decimal   @db.Decimal(12, 2)
  platformFee      Decimal   @db.Decimal(12, 2)
  netAmount        Decimal   @db.Decimal(12, 2)
  regularPay       Decimal?  @db.Decimal(12, 2)
  overtimePay      Decimal?  @db.Decimal(12, 2)
  commissionPay    Decimal?  @db.Decimal(12, 2)
  bonusAmount      Decimal?  @db.Decimal(12, 2)
  description      String?
  status           String    @default("pending") // pending, processing, completed, failed
  stripeTransferId String?
  failureReason    String?
  paidAt           DateTime? @db.Timestamp(6)
  createdAt        DateTime  @default(now()) @db.Timestamp(6)

  landlord   Landlord   @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  timesheet  Timesheet? @relation(fields: [timesheetId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([teamMemberId])
  @@index([status])
  @@index([paidAt])
}

// Payroll settings for landlord
model PayrollSettings {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId             String   @unique @db.Uuid
  payPeriodType          String   @default("biweekly") // weekly, biweekly, semimonthly, monthly
  payPeriodStartDay      Int      @default(1) // Day of week (0-6) or day of month (1-31)
  overtimeThreshold      Decimal  @default(40) @db.Decimal(5, 2) // Hours per week
  dailyOvertimeThreshold Decimal? @db.Decimal(5, 2) // Hours per day (optional)
  overtimeMultiplier     Decimal  @default(1.5) @db.Decimal(3, 2)
  createdAt              DateTime @default(now()) @db.Timestamp(6)
  updatedAt              DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
}

// ============= HIRING (ENTERPRISE) =============

// Job postings for hiring
model JobPosting {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId   String   @db.Uuid
  title        String
  description  String
  type         String   @default("full-time") // full-time, part-time, contract
  location     String
  salary       String?
  requirements String?
  benefits     String?
  status       String   @default("draft") // draft, active, closed
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  landlord   Landlord       @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  applicants JobApplicant[]

  @@index([landlordId])
  @@index([status])
}

// Job applicants
model JobApplicant {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId       String   @db.Uuid
  landlordId  String   @db.Uuid
  name        String
  email       String
  phone       String?
  resumeUrl   String?
  coverLetter String?
  status      String   @default("new") // new, reviewing, interview, offered, hired, rejected
  notes       String?
  appliedAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  job      JobPosting @relation(fields: [jobId], references: [id], onDelete: Cascade)
  landlord Landlord   @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([landlordId])
  @@index([status])
}

// ============= REAL ESTATE AGENTS =============

// Agent - Real estate agent profile
model Agent {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String    @unique @db.Uuid
  name             String
  subdomain        String    @unique
  licenseNumber    String?
  licenseState     String?
  licenseExpiry    DateTime? @db.Date
  brokerage        String?
  brokerageAddress String?

  // Branding
  logoUrl        String?
  customDomain   String?  @unique
  companyName    String?
  companyEmail   String?
  companyPhone   String?
  companyAddress String?
  themeColor     String   @default("violet")
  heroImages     String[] @default([])
  aboutBio       String?
  aboutPhoto     String?
  aboutGallery   String[] @default([])

  // Social & Contact
  website      String?
  facebookUrl  String?
  instagramUrl String?
  linkedinUrl  String?
  youtubeUrl   String?

  // Specializations
  specializations String[] @default([]) // residential, commercial, luxury, first-time-buyers, etc.
  serviceAreas    String[] @default([]) // Cities/neighborhoods served
  languages       String[] @default([])

  // Stats
  yearsExperience Int?
  totalSales      Int  @default(0)
  totalListings   Int  @default(0)

  // Subscription
  subscriptionTier     String    @default("starter")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   String    @default("active")
  subscriptionEndsAt   DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  listings   AgentListing[]
  leads      AgentLead[]
  openHouses AgentOpenHouse[]
  workOrders AgentWorkOrder[]

  @@index([subdomain])
  @@index([licenseState])
}

// AgentWorkOrder - Jobs posted by real estate agents for contractors
model AgentWorkOrder {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId       String    @db.Uuid
  contractorId  String?   @db.Uuid
  listingId     String?   @db.Uuid // Optional link to a listing
  title         String
  description   String
  category      String // plumbing, electrical, hvac, painting, landscaping, staging, cleaning, general
  status        String    @default("open") // open, assigned, in_progress, completed, cancelled
  priority      String    @default("medium") // low, medium, high, urgent
  budgetMin     Decimal?  @db.Decimal(12, 2)
  budgetMax     Decimal?  @db.Decimal(12, 2)
  agreedPrice   Decimal?  @db.Decimal(12, 2)
  scheduledDate DateTime? @db.Timestamp(6)
  completedAt   DateTime? @db.Timestamp(6)
  address       Json?     @db.Json // Property address for the job
  images        String[]  @default([])
  notes         String?
  isOpenBid     Boolean   @default(true)
  bidDeadline   DateTime? @db.Timestamp(6)
  createdAt     DateTime  @default(now()) @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt

  agent   Agent               @relation(fields: [agentId], references: [id], onDelete: Cascade)
  listing AgentListing?       @relation(fields: [listingId], references: [id], onDelete: SetNull)
  bids    AgentWorkOrderBid[]

  @@index([agentId])
  @@index([status])
  @@index([isOpenBid])
}

// AgentWorkOrderBid - Contractor bids on agent jobs
model AgentWorkOrderBid {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workOrderId       String    @db.Uuid
  contractorId      String    @db.Uuid
  amount            Decimal   @db.Decimal(12, 2)
  estimatedHours    Decimal?  @db.Decimal(6, 2)
  proposedStartDate DateTime? @db.Timestamp(6)
  message           String?
  status            String    @default("pending") // pending, accepted, declined, withdrawn
  createdAt         DateTime  @default(now()) @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt

  workOrder AgentWorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@unique([workOrderId, contractorId])
  @@index([workOrderId])
  @@index([contractorId])
}

// AgentListing - Properties for sale
model AgentListing {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId String @db.Uuid

  // Property Details
  title        String
  slug         String  @unique
  description  String?
  propertyType String // house, condo, townhouse, land, multi-family, commercial
  listingType  String  @default("sale") // sale, lease, auction
  status       String  @default("active") // active, pending, sold, withdrawn, expired

  // Address
  address Json @db.Json // { street, city, state, zip, lat, lng }

  // Pricing
  price        Decimal  @db.Decimal(12, 2)
  pricePerSqFt Decimal? @db.Decimal(10, 2)
  hoaFees      Decimal? @db.Decimal(10, 2)
  taxAmount    Decimal? @db.Decimal(10, 2)

  // Property Specs
  bedrooms      Int?
  bathrooms     Decimal? @db.Decimal(3, 1)
  halfBaths     Int?
  sizeSqFt      Int?
  lotSizeSqFt   Int?
  lotSizeAcres  Decimal? @db.Decimal(10, 4)
  yearBuilt     Int?
  stories       Int?
  garage        Int? // Number of garage spaces
  parkingSpaces Int?

  // Features
  features   String[] @default([]) // pool, fireplace, hardwood, etc.
  appliances String[] @default([])
  heating    String?
  cooling    String?
  flooring   String[] @default([])
  roof       String?
  foundation String?

  // Media
  images         String[] @default([])
  videoUrl       String?
  virtualTourUrl String?
  floorPlanUrl   String?

  // MLS
  mlsNumber String?
  mlsSource String?

  // Dates
  listedAt  DateTime  @default(now()) @db.Timestamp(6)
  soldAt    DateTime? @db.Timestamp(6)
  soldPrice Decimal?  @db.Decimal(12, 2)
  expiresAt DateTime? @db.Timestamp(6)

  // Visibility
  isFeatured  Boolean @default(false)
  showAddress Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  agent      Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)
  leads      AgentLead[]
  openHouses AgentOpenHouse[]
  workOrders AgentWorkOrder[]

  @@index([agentId])
  @@index([status])
  @@index([propertyType])
  @@index([listingType])
  @@index([price])
}

// AgentLead - Potential buyers/sellers
model AgentLead {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId   String  @db.Uuid
  listingId String? @db.Uuid

  // Contact Info
  name  String
  email String
  phone String?

  // Lead Details
  type              String   @default("buyer") // buyer, seller, both
  source            String? // website, referral, open_house, zillow, etc.
  status            String   @default("new") // new, contacted, qualified, showing, offer, closed, lost
  budget            Decimal? @db.Decimal(12, 2)
  preApproved       Boolean  @default(false)
  preApprovalAmount Decimal? @db.Decimal(12, 2)

  // Preferences (for buyers)
  preferredAreas String[] @default([])
  preferredTypes String[] @default([])
  minBedrooms    Int?
  minBathrooms   Int?
  minSqFt        Int?
  maxPrice       Decimal? @db.Decimal(12, 2)
  timeline       String? // immediately, 1-3 months, 3-6 months, 6+ months

  // Notes
  notes         String?
  lastContactAt DateTime? @db.Timestamp(6)
  nextFollowUp  DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  agent   Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  listing AgentListing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@index([agentId])
  @@index([listingId])
  @@index([status])
  @@index([type])
}

// AgentOpenHouse - Open house events
model AgentOpenHouse {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agentId   String @db.Uuid
  listingId String @db.Uuid

  date      DateTime @db.Date
  startTime String // "14:00" format
  endTime   String // "17:00" format

  notes       String?
  isVirtual   Boolean @default(false)
  virtualLink String?

  // RSVP tracking
  rsvpEnabled  Boolean @default(false)
  maxAttendees Int?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  agent   Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  listing AgentListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([listingId])
  @@index([date])
}

// ============= AFFILIATE PROGRAM =============

// Affiliate - People who refer new landlords/subscribers
model Affiliate {
  id    String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name  String
  email String  @unique
  phone String?
  code  String  @unique // Unique referral code (e.g., "SISTER5", "JOHN2024")

  // Status
  status String @default("active") // active, paused, terminated

  // Commission settings (can override defaults)
  commissionBasic      Decimal @default(5) @db.Decimal(10, 2) // $5 for $19.99 Starter plan
  commissionPro        Decimal @default(10) @db.Decimal(10, 2) // $10 for $39.99 Pro plan
  commissionEnterprise Decimal @default(25) @db.Decimal(10, 2) // $25 for $79.99 Enterprise plan

  // Payment info
  paymentMethod    String? // paypal, venmo, check, bank_transfer
  paymentEmail     String? // PayPal/Venmo email
  paymentPhone     String? // Venmo phone
  bankAccountLast4 String?
  minimumPayout    Decimal @default(25) @db.Decimal(10, 2) // Minimum balance to request payout

  // Stats (denormalized for quick access)
  totalClicks     Int     @default(0)
  totalSignups    Int     @default(0)
  totalEarnings   Decimal @default(0) @db.Decimal(12, 2)
  pendingEarnings Decimal @default(0) @db.Decimal(12, 2)
  paidEarnings    Decimal @default(0) @db.Decimal(12, 2)

  // Tier system for high performers
  tier String @default("standard") // standard, silver, gold, platinum

  notes     String?
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  referrals AffiliateReferral[]
  payouts   AffiliatePayout[]
  clicks    AffiliateClick[]

  @@index([code])
  @@index([email])
  @@index([status])
}

// AffiliateClick - Track link clicks for analytics
model AffiliateClick {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  affiliateId String @db.Uuid

  // Tracking info
  ipAddress   String?
  userAgent   String?
  referrerUrl String? // Where they came from
  landingPage String? // Which page they landed on

  // Geo info
  country String?
  region  String?
  city    String?

  // Session tracking
  sessionId String? // To link click to eventual signup

  createdAt DateTime @default(now()) @db.Timestamp(6)

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([sessionId])
  @@index([createdAt])
}

// AffiliateReferral - Successful signups from affiliates
model AffiliateReferral {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  affiliateId String @db.Uuid
  landlordId  String @unique @db.Uuid // The landlord who signed up

  // Subscription info at time of signup
  subscriptionTier  String // basic, pro, enterprise
  subscriptionPrice Decimal @db.Decimal(10, 2) // Price they paid

  // Commission
  commissionAmount Decimal @db.Decimal(10, 2)
  commissionStatus String  @default("pending") // pending, approved, paid, cancelled

  // Pending period (30 days to prevent fraud/refunds)
  pendingUntil DateTime  @db.Timestamp(6)
  approvedAt   DateTime? @db.Timestamp(6)
  paidAt       DateTime? @db.Timestamp(6)
  payoutId     String?   @db.Uuid

  // Cancellation tracking
  cancelledAt        DateTime? @db.Timestamp(6)
  cancellationReason String?

  // Recurring commission tracking (optional - for ongoing commissions)
  isRecurring     Boolean @default(false)
  recurringMonths Int     @default(0) // How many months of recurring commission

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  affiliate Affiliate        @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  landlord  Landlord         @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  payout    AffiliatePayout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)

  @@index([affiliateId])
  @@index([landlordId])
  @@index([commissionStatus])
  @@index([createdAt])
}

// AffiliatePayout - Payment records to affiliates
model AffiliatePayout {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  affiliateId String @db.Uuid

  amount         Decimal @db.Decimal(12, 2)
  paymentMethod  String // paypal, venmo, check, bank_transfer
  paymentDetails String? // Email, phone, or check number

  status String @default("pending") // pending, processing, completed, failed

  // Processing info
  processedAt   DateTime? @db.Timestamp(6)
  completedAt   DateTime? @db.Timestamp(6)
  failedAt      DateTime? @db.Timestamp(6)
  failureReason String?

  // Reference
  transactionId String? // External payment reference
  notes         String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  affiliate Affiliate           @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  referrals AffiliateReferral[]

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
}

// ============= SECURITY & AUDIT =============

// Two-Factor Authentication
model TwoFactorAuth {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String    @unique @db.Uuid
  secretEncrypted      String // Encrypted TOTP secret
  backupCodesEncrypted String? // Encrypted backup codes JSON array
  isEnabled            Boolean   @default(false)
  verifiedAt           DateTime? @db.Timestamp(6)
  lastUsedAt           DateTime? @db.Timestamp(6)
  createdAt            DateTime  @default(now()) @db.Timestamp(6)
  updatedAt            DateTime  @updatedAt

  @@index([userId])
}

// Audit Log for tracking sensitive operations
model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action       String // AUTH_LOGIN, PAYMENT_COMPLETED, etc.
  userId       String?  @db.Uuid
  landlordId   String?  @db.Uuid
  resourceType String? // transaction, auth, lease, etc.
  resourceId   String?  @db.Uuid
  metadata     String? // JSON string with additional data
  ipAddress    String?
  userAgent    String?
  severity     String   @default("INFO") // INFO, WARNING, CRITICAL
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@index([userId])
  @@index([landlordId])
  @@index([action])
  @@index([createdAt])
  @@index([severity])
}

// Rate Limit tracking (for persistent rate limiting)
model RateLimitRecord {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier  String // IP address, user ID, or combined key
  endpoint    String // API endpoint or action type
  count       Int      @default(1)
  windowStart DateTime @db.Timestamp(6)
  windowEnd   DateTime @db.Timestamp(6)
  createdAt   DateTime @default(now()) @db.Timestamp(6)

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier])
  @@index([windowEnd])
}

// ============= REFERRAL PROGRAM =============

// Referral codes for landlords
model ReferralCode {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String   @unique
  landlordId String   @db.Uuid
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now()) @db.Timestamp(6)

  referrals Referral[]

  @@index([code])
  @@index([landlordId])
}

// Referral tracking
model Referral {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  referrerLandlordId String    @db.Uuid
  referredLandlordId String    @db.Uuid
  referralCodeId     String    @db.Uuid
  status             String    @default("pending") // pending, completed, expired
  rewardAmount       Decimal?  @db.Decimal(10, 2)
  completedAt        DateTime? @db.Timestamp(6)
  createdAt          DateTime  @default(now()) @db.Timestamp(6)
  updatedAt          DateTime  @updatedAt

  referralCode ReferralCode     @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  credits      ReferralCredit[]

  @@index([referrerLandlordId])
  @@index([referredLandlordId])
  @@index([status])
}

// Referral credits/rewards
model ReferralCredit {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId String    @db.Uuid
  referralId String    @db.Uuid
  amount     Decimal   @db.Decimal(10, 2)
  usedAt     DateTime? @db.Timestamp(6)
  expiresAt  DateTime  @db.Timestamp(6)
  createdAt  DateTime  @default(now()) @db.Timestamp(6)

  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([expiresAt])
}

// ============= NEWSLETTER & LEADS =============

// Newsletter subscribers
model NewsletterSubscriber {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String    @unique
  name           String?
  source         String? // homepage, blog, exit_intent, etc.
  status         String    @default("active") // active, unsubscribed, bounced
  subscribedAt   DateTime  @default(now()) @db.Timestamp(6)
  unsubscribedAt DateTime? @db.Timestamp(6)
  metadata       Json?     @db.Json

  @@index([email])
  @@index([status])
}

// ============= DISPUTE CENTER =============

// Dispute - Contractor marketplace disputes
model Dispute {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caseNumber String @unique // AUTO-GENERATED: DSP-YYYYMMDD-XXXX

  // Parties involved
  landlordId   String  @db.Uuid
  contractorId String? @db.Uuid
  homeownerId  String? @db.Uuid
  workOrderId  String? @db.Uuid

  // Dispute details
  type     String // payment, quality, timeline, scope, communication, other
  category String // work_not_completed, poor_quality, overcharge, damage, no_show, contract_breach, other
  status   String @default("open") // open, under_review, mediation, escalated, resolved, closed, cancelled
  priority String @default("medium") // low, medium, high, urgent

  // Financial
  disputedAmount Decimal? @db.Decimal(12, 2)
  resolvedAmount Decimal? @db.Decimal(12, 2)
  escrowHeld     Decimal? @db.Decimal(12, 2)

  // Description
  title             String
  description       String
  desiredResolution String?

  // Resolution
  resolution     String?
  resolutionType String? // refund_full, refund_partial, work_redo, mediated_agreement, dismissed, other
  resolvedById   String?   @db.Uuid
  resolvedAt     DateTime? @db.Timestamp(6)

  // Assignment
  assignedToId String?   @db.Uuid
  assignedAt   DateTime? @db.Timestamp(6)

  // SLA tracking
  responseDeadline   DateTime? @db.Timestamp(6)
  resolutionDeadline DateTime? @db.Timestamp(6)

  // Metadata
  filedById   String @db.Uuid
  filedByRole String // landlord, contractor, homeowner, admin

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  // Relations
  landlord   Landlord          @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  filedBy    User              @relation("DisputeFiledBy", fields: [filedById], references: [id], onDelete: Cascade)
  assignedTo User?             @relation("DisputeAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  resolvedBy User?             @relation("DisputeResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)
  messages   DisputeMessage[]
  evidence   DisputeEvidence[]
  timeline   DisputeTimeline[]

  @@index([landlordId])
  @@index([contractorId])
  @@index([homeownerId])
  @@index([workOrderId])
  @@index([status])
  @@index([priority])
  @@index([caseNumber])
  @@index([createdAt])
}

// DisputeMessage - Communication thread for disputes
model DisputeMessage {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  disputeId  String    @db.Uuid
  senderId   String    @db.Uuid
  senderRole String // landlord, contractor, homeowner, admin, mediator
  message    String
  isInternal Boolean   @default(false) // Internal notes not visible to parties
  readAt     DateTime? @db.Timestamp(6)
  createdAt  DateTime  @default(now()) @db.Timestamp(6)

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  sender  User    @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@index([senderId])
  @@index([createdAt])
}

// DisputeEvidence - Supporting documents and media
model DisputeEvidence {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  disputeId    String   @db.Uuid
  uploadedById String   @db.Uuid
  type         String // image, video, document, contract, invoice, receipt, screenshot, other
  url          String
  fileName     String?
  fileSize     Int?
  mimeType     String?
  description  String?
  category     String? // before_work, after_work, communication, contract, payment, other
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  dispute    Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  uploadedBy User    @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@index([uploadedById])
}

// DisputeTimeline - Audit trail of dispute actions
model DisputeTimeline {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  disputeId     String   @db.Uuid
  action        String // created, status_changed, assigned, message_sent, evidence_added, escalated, resolved, closed
  description   String
  previousValue String?
  newValue      String?
  performedById String   @db.Uuid
  metadata      Json?    @db.Json
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  dispute     Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  performedBy User    @relation(fields: [performedById], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@index([createdAt])
}

// ============= ENTERPRISE API & WEBHOOKS =============

// API Keys for external integrations (Enterprise tier)
model ApiKey {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId      String    @db.Uuid
  name            String    @db.VarChar(255)
  keyHash         String    @unique @db.VarChar(255) // SHA-256 hash of the key
  keyPrefix       String    @db.VarChar(12) // First 8 chars for identification (e.g., "pk_live_")
  scopes          String[]  @default([]) // ["properties:read", "tenants:write", etc.]
  rateLimit       Int       @default(1000) // Requests per window
  rateLimitWindow Int       @default(3600) // Window in seconds (default 1 hour)
  lastUsedAt      DateTime? @db.Timestamp(6)
  expiresAt       DateTime? @db.Timestamp(6)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now()) @db.Timestamp(6)
  updatedAt       DateTime  @updatedAt

  landlord    Landlord        @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  requestLogs ApiRequestLog[]

  @@index([landlordId])
  @@index([keyPrefix])
  @@index([isActive])
}

// Webhook Endpoints configuration
model WebhookEndpoint {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId        String    @db.Uuid
  url               String    @db.VarChar(2048)
  description       String?   @db.VarChar(500)
  secret            String    @db.VarChar(255) // HMAC signing secret
  events            String[]  @default([]) // ["payment.completed", "lease.created", etc.]
  isActive          Boolean   @default(true)
  version           String    @default("v1") @db.VarChar(10)
  failureCount      Int       @default(0)
  lastSuccessAt     DateTime? @db.Timestamp(6)
  lastFailureAt     DateTime? @db.Timestamp(6)
  lastFailureReason String?
  createdAt         DateTime  @default(now()) @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt

  landlord   Landlord          @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([landlordId])
  @@index([isActive])
}

// Webhook Delivery Log
model WebhookDelivery {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  webhookEndpointId String    @db.Uuid
  eventType         String    @db.VarChar(100)
  payload           Json      @db.JsonB
  status            String    @default("pending") @db.VarChar(20) // pending, delivered, failed, retrying
  httpStatus        Int?
  responseBody      String?
  responseTimeMs    Int?
  attempts          Int       @default(0)
  maxAttempts       Int       @default(5)
  nextRetryAt       DateTime? @db.Timestamp(6)
  deliveredAt       DateTime? @db.Timestamp(6)
  createdAt         DateTime  @default(now()) @db.Timestamp(6)

  webhookEndpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
  @@index([nextRetryAt])
}

// API Request Log for analytics
model ApiRequestLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  apiKeyId       String?  @db.Uuid
  landlordId     String   @db.Uuid
  method         String   @db.VarChar(10)
  path           String   @db.VarChar(500)
  statusCode     Int
  responseTimeMs Int?
  ipAddress      String?  @db.VarChar(45)
  userAgent      String?
  errorMessage   String?
  createdAt      DateTime @default(now()) @db.Timestamp(6)

  apiKey   ApiKey?  @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)
  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([landlordId])
  @@index([createdAt])
  @@index([path])
}

// ============= STRIPE TREASURY =============

// Financial Account - Stripe Treasury account for holding funds
model FinancialAccount {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId               String?  @db.Uuid
  contractorId             String?  @db.Uuid
  stripeConnectedAccountId String   @db.VarChar(255) // acct_xxx
  stripeFinancialAccountId String   @unique @db.VarChar(255) // fa_xxx
  status                   String   @default("pending") @db.VarChar(50) // pending, active, closed
  routingNumber            String?  @db.VarChar(20)
  accountNumberLast4       String?  @db.VarChar(4)
  bankName                 String?  @db.VarChar(100)
  availableBalance         Decimal  @default(0) @db.Decimal(12, 2)
  pendingBalance           Decimal  @default(0) @db.Decimal(12, 2)
  activeFeatures           String[] @default([])
  createdAt                DateTime @default(now()) @db.Timestamp(6)
  updatedAt                DateTime @updatedAt

  transactions FinancialAccountTransaction[]

  @@index([landlordId])
  @@index([contractorId])
  @@index([stripeConnectedAccountId])
  @@index([status])
}

// Financial Account Transaction - Treasury transaction history
model FinancialAccountTransaction {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  financialAccountId  String   @db.Uuid
  stripeTransactionId String?  @db.VarChar(255)
  type                String   @db.VarChar(50) // inbound_transfer, outbound_payment, received_credit, etc.
  amount              Decimal  @db.Decimal(12, 2)
  currency            String   @default("usd") @db.VarChar(3)
  status              String   @db.VarChar(50) // pending, posted, void, returned
  description         String?
  counterpartyName    String?  @db.VarChar(255)
  counterpartyType    String?  @db.VarChar(50) // bank_account, financial_account
  metadata            Json?    @db.JsonB
  createdAt           DateTime @default(now()) @db.Timestamp(6)

  financialAccount FinancialAccount @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)

  @@index([financialAccountId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ============= CONTRACTOR MARKETPLACE =============

// ContractorProfile - Public marketplace profile for contractors
model ContractorProfile {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @unique @db.Uuid
  slug   String @unique // contractor-name-123 for URL

  // Basic Info
  businessName String
  displayName  String
  tagline      String? // Short description like "Licensed Plumber - 15 Years Experience"
  bio          String?
  profilePhoto String?
  coverPhoto   String?

  // Contact & Location
  email         String
  phone         String?
  website       String?
  serviceAreas  String[] @default([]) // zip codes or city names
  serviceRadius Int? // miles from base location
  baseCity      String?
  baseState     String?

  // Professional Info
  specialties       String[]  @default([]) // plumbing, electrical, HVAC, etc.
  yearsExperience   Int?
  licenseNumber     String?
  licenseState      String?
  insuranceVerified Boolean   @default(false)
  insuranceExpiry   DateTime? @db.Timestamp(6)
  backgroundChecked Boolean   @default(false)

  // Portfolio
  portfolioImages String[] @default([])
  portfolioVideos String[] @default([])

  // Availability
  isAvailable       Boolean @default(true)
  availabilityNotes String?

  // Marketplace Settings
  isPublic         Boolean  @default(true) // visible in marketplace
  acceptingNewWork Boolean  @default(true)
  minimumJobSize   Decimal? @db.Decimal(12, 2)
  hourlyRate       Decimal? @db.Decimal(10, 2)

  // Computed/Cached Stats (updated by ranking job)
  rankScore        Float @default(0) // 0-100 composite score
  avgRating        Float @default(0) // 1-5 stars
  totalReviews     Int   @default(0)
  completedJobs    Int   @default(0)
  responseRate     Float @default(0) // % of messages responded to
  onTimeRate       Float @default(0) // % completed on schedule
  repeatClientRate Float @default(0) // % of clients who hire again

  // Verification
  identityVerified Boolean @default(false)
  taxId            String? // EIN or SSN last 4 (encrypted)
  verifiedPhone    String?

  // Enhanced Verification - License
  licenseVerifiedAt       DateTime? @db.Timestamp(6)
  licenseExpiresAt        DateTime? @db.Timestamp(6)
  licenseVerificationData Json?     @db.Json // Store API response

  // Enhanced Verification - Insurance
  insuranceCertificateUrl String?
  insuranceCoverageAmount Decimal? @db.Decimal(12, 2)
  insuranceProvider       String?

  // Enhanced Verification - Background Check
  backgroundCheckId      String? // Checkr report ID
  backgroundCheckDate    DateTime? @db.Timestamp(6)
  backgroundCheckExpires DateTime? @db.Timestamp(6)

  // Enhanced Verification - Identity
  identityVerificationId String? // Persona inquiry ID
  identityVerifiedAt     DateTime? @db.Timestamp(6)

  // Instant Booking
  instantBookingEnabled Boolean  @default(false)
  depositRequired       Boolean  @default(false)
  depositAmount         Decimal? @db.Decimal(10, 2)
  depositPercent        Decimal? @db.Decimal(5, 2)
  cancellationPolicy    String? // 'flexible', 'moderate', 'strict'
  cancellationHours     Int      @default(24)

  // Calendar Integration
  googleCalendarToken  String?
  googleCalendarId     String?
  outlookCalendarToken String?
  outlookCalendarId    String?

  // Subscription
  subscriptionTier     String? // 'starter', 'pro', 'enterprise'
  stripeSubscriptionId String?
  stripeCustomerId     String?
  subscriptionStatus   String    @default("none") // none, active, past_due, canceled
  subscriptionEndsAt   DateTime? @db.Timestamp(6)

  // Subdomain & Branding (mirrors landlord subdomain)
  subdomain  String?  @unique // contractor's custom subdomain
  logoUrl    String?
  themeColor String?  @default("violet") // violet, emerald, blue, rose, amber
  heroImages String[] @default([])

  // About Page Content
  aboutBio     String?
  aboutPhoto   String?
  aboutGallery String[] @default([])

  // "Why Choose Me" Feature Cards (6 customizable cards)
  featureCard1Title       String?
  featureCard1Description String?
  featureCard1Icon        String? @default("zap") // icon name
  featureCard2Title       String?
  featureCard2Description String?
  featureCard2Icon        String? @default("dollar-sign")
  featureCard3Title       String?
  featureCard3Description String?
  featureCard3Icon        String? @default("shield")
  featureCard4Title       String?
  featureCard4Description String?
  featureCard4Icon        String? @default("clock")
  featureCard5Title       String?
  featureCard5Description String?
  featureCard5Icon        String? @default("smartphone")
  featureCard6Title       String?
  featureCard6Description String?
  featureCard6Icon        String? @default("briefcase")

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews ContractorReview[]

  // Lead generation relations
  leadMatches     ContractorLeadMatch[]
  leadCredit      ContractorLeadCredit?
  leadPreferences ContractorLeadPreferences?

  // Instant booking appointments
  appointments ContractorAppointment[]

  // Invoicing
  invoices ContractorInvoice[]

  // CRM - Customer management
  customers ContractorCustomer[]

  // Scheduler availability
  availability ContractorAvailability?

  @@index([slug])
  @@index([rankScore])
  @@index([avgRating])
  @@index([isPublic, acceptingNewWork])
  @@index([baseCity, baseState])
}

// ContractorReview - Reviews from landlords/homeowners (fraud-protected)
model ContractorReview {
  id                  String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorProfileId String @db.Uuid
  reviewerId          String @db.Uuid
  workOrderId         String @db.Uuid // REQUIRED - must have completed job

  // Ratings (1-5 stars)
  overallRating       Int
  qualityRating       Int?
  communicationRating Int?
  timelinessRating    Int?
  valueRating         Int?

  // Review Content
  title   String?
  content String

  // Job context for verification
  jobType  String? // plumbing, electrical, etc.
  jobValue Decimal? @db.Decimal(12, 2) // For weighted scoring

  // Verification
  isVerified         Boolean @default(false) // linked to completed & paid work order
  verificationMethod String? // "work_order_completion", "payment_confirmed"

  // Moderation
  status     String  @default("published") // pending, published, flagged, removed
  flagReason String?

  // Response
  contractorResponse String?
  respondedAt        DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  contractorProfile ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)
  reviewer          User              @relation("ContractorReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)

  @@unique([contractorProfileId, workOrderId]) // One review per job
  @@unique([reviewerId, workOrderId]) // Reviewer can only review once per job
  @@index([contractorProfileId])
  @@index([reviewerId])
  @@index([status])
  @@index([createdAt])
}

// ============= PROPERTY-SPECIFIC FEE SETTINGS =============

// Property-specific fee overrides - allows customizing fees per property
model PropertyFeeSettings {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId String @unique @db.Uuid
  landlordId String @db.Uuid

  // Security Deposit Override
  securityDepositMonths Decimal? @db.Decimal(3, 1) // null = use landlord default
  noSecurityDeposit     Boolean  @default(false) // If true, no security deposit required

  // Last Month's Rent Override
  lastMonthRentRequired Boolean? // null = use landlord default

  // Pet Fees Override
  petDepositEnabled Boolean? // null = use landlord default
  petDepositAmount  Decimal? @db.Decimal(12, 2)
  petRentEnabled    Boolean?
  petRentAmount     Decimal? @db.Decimal(12, 2)
  noPetFees         Boolean  @default(false) // If true, no pet fees for this property

  // Cleaning Fee Override
  cleaningFeeEnabled Boolean?
  cleaningFeeAmount  Decimal? @db.Decimal(12, 2)
  noCleaningFee      Boolean  @default(false)

  // Application Fee Override
  applicationFeeEnabled Boolean?
  applicationFeeAmount  Decimal? @db.Decimal(12, 2)
  noApplicationFee      Boolean  @default(false)

  // Late Fee Override (Pro feature)
  lateFeeEnabled  Boolean?
  gracePeriodDays Int?
  lateFeeType     String? // 'flat' | 'percentage'
  lateFeeAmount   Decimal? @db.Decimal(12, 2)
  lateFeeMaxFee   Decimal? @db.Decimal(12, 2)
  noLateFees      Boolean  @default(false)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([landlordId])
}

// ============= CONTRACTOR LEAD GENERATION SYSTEM =============

// ContractorLead - A lead/project request from a homeowner or landlord
model ContractorLead {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Lead source
  source   String  @default("marketplace") // marketplace, work_order, subdomain, referral
  sourceId String? @db.Uuid // work order ID, referral ID, etc.

  // Customer info
  customerName   String
  customerEmail  String
  customerPhone  String?
  customerUserId String? @db.Uuid // if registered user

  // Project details
  projectType        String // matches contractor specialties (plumbing, electrical, etc.)
  projectTitle       String?
  projectDescription String
  projectPhotos      String[] @default([])
  budgetMin          Decimal? @db.Decimal(12, 2)
  budgetMax          Decimal? @db.Decimal(12, 2)
  timeline           String? // asap, this_week, this_month, flexible
  urgency            String   @default("normal") // emergency, urgent, normal, flexible

  // Location
  propertyAddress String?
  propertyCity    String?
  propertyState   String?
  propertyZip     String?
  propertyType    String? // residential, commercial, multi_family

  // Lead quality
  leadScore      Int     @default(0) // 0-100 quality score
  isVerified     Boolean @default(false) // email/phone verified
  isExclusive    Boolean @default(false) // exclusive lead (sent to 1 contractor)
  maxContractors Int     @default(3) // max contractors to match

  // Status
  status String @default("new") // new, matching, sent, responded, booked, completed, expired, cancelled

  // Timestamps
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
  expiresAt DateTime // leads expire after 7 days

  // Relations
  matches  ContractorLeadMatch[]
  customer User?                 @relation(fields: [customerUserId], references: [id])

  @@index([status])
  @@index([projectType])
  @@index([propertyZip])
  @@index([createdAt])
  @@index([customerUserId])
}

// ContractorLeadMatch - Links a lead to matched contractors
model ContractorLeadMatch {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId       String @db.Uuid
  contractorId String @db.Uuid

  // Pricing model used
  pricingModel      String   @default("per_lead") // per_lead, per_booking, subscription, free
  leadCost          Decimal? @db.Decimal(10, 2) // cost charged for this lead
  bookingFeePercent Decimal? @db.Decimal(5, 2) // % fee if pay-per-booking

  // Match quality
  matchScore  Int     @default(0) // how well contractor matches lead
  matchReason String? // why this contractor was matched
  priority    Int     @default(0) // display order (higher = shown first)

  // Status tracking
  status      String    @default("pending") // pending, sent, viewed, responded, quoted, won, lost, expired, refunded
  sentAt      DateTime?
  viewedAt    DateTime?
  respondedAt DateTime?
  quotedAt    DateTime?

  // Contractor response
  responseMessage   String?
  quoteAmount       Decimal? @db.Decimal(12, 2)
  quoteNotes        String?
  estimatedDuration String?

  // Outcome
  wasBooked   Boolean   @default(false)
  jobValue    Decimal?  @db.Decimal(12, 2)
  bookingFee  Decimal?  @db.Decimal(10, 2)
  completedAt DateTime?

  // Refund tracking
  refundRequested Boolean   @default(false)
  refundApproved  Boolean   @default(false)
  refundReason    String?
  refundAmount    Decimal?  @db.Decimal(10, 2)
  refundedAt      DateTime?

  // Relations
  lead       ContractorLead    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contractor ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@unique([leadId, contractorId])
  @@index([contractorId])
  @@index([status])
  @@index([createdAt])
}

// ContractorLeadCredit - Contractor's lead credit balance and subscription
model ContractorLeadCredit {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorId String @unique @db.Uuid

  // Credit balance (for pay-per-lead)
  creditBalance Decimal @default(0) @db.Decimal(10, 2)

  // Subscription info
  subscriptionTier   String? // starter, pro, enterprise
  subscriptionStatus String    @default("none") // none, active, cancelled, past_due
  leadsIncluded      Int       @default(0) // leads included in subscription
  leadsUsedThisMonth Int       @default(0)
  billingCycleStart  DateTime?

  // Preferred pricing model
  preferredPricing String @default("per_lead") // per_lead, per_booking, subscription

  // Stripe billing
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Lead preferences
  maxLeadCost       Decimal? @db.Decimal(10, 2) // max willing to pay per lead
  autoAcceptLeads   Boolean  @default(false) // auto-accept matching leads
  leadNotifications Boolean  @default(true)

  // Relations
  contractor   ContractorProfile             @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  transactions ContractorCreditTransaction[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

// ContractorCreditTransaction - Credit/debit transactions
model ContractorCreditTransaction {
  id              String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  creditAccountId String @db.Uuid

  type         String // purchase, lead_charge, booking_fee, refund, subscription, bonus, adjustment
  amount       Decimal @db.Decimal(10, 2) // positive = credit, negative = debit
  balanceAfter Decimal @db.Decimal(10, 2) // balance after transaction
  description  String

  // References
  leadMatchId     String? @db.Uuid
  stripePaymentId String?
  stripeInvoiceId String?

  // Relations
  creditAccount ContractorLeadCredit @relation(fields: [creditAccountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([creditAccountId])
  @@index([type])
  @@index([createdAt])
}

// ContractorLeadPreferences - Contractor's lead matching preferences
model ContractorLeadPreferences {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorId String @unique @db.Uuid

  // Service preferences
  acceptedTypes String[] @default([]) // project types willing to accept
  excludedTypes String[] @default([]) // project types to exclude

  // Budget preferences
  minJobValue Decimal? @db.Decimal(12, 2)
  maxJobValue Decimal? @db.Decimal(12, 2)

  // Location preferences
  serviceZipCodes String[] @default([])
  serviceRadius   Int? // miles from base location

  // Timing preferences
  acceptEmergency Boolean @default(true)
  acceptWeekends  Boolean @default(false)
  maxLeadsPerDay  Int?
  maxLeadsPerWeek Int?

  // Customer preferences
  residentialOnly Boolean @default(false)
  commercialOnly  Boolean @default(false)

  // Availability
  isPaused    Boolean   @default(false) // temporarily stop receiving leads
  pausedUntil DateTime?

  // Relations
  contractor ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

// ContractorAppointment - Appointments for instant booking
model ContractorAppointment {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorId String @db.Uuid
  customerId   String @db.Uuid

  // Appointment Details
  serviceType String
  title       String
  description String?
  address     Json    @db.Json

  // Timing
  startTime DateTime @db.Timestamp(6)
  endTime   DateTime @db.Timestamp(6)

  // Status
  status             String    @default("confirmed") // confirmed, completed, cancelled, no_show
  cancelledAt        DateTime? @db.Timestamp(6)
  cancelledBy        String? // 'contractor' or 'customer'
  cancellationReason String?

  // Payment
  depositAmount    Decimal? @db.Decimal(10, 2)
  depositPaid      Boolean  @default(false)
  depositPaymentId String?

  // Job linkage
  jobId String? @db.Uuid

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  contractor ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([contractorId])
  @@index([customerId])
  @@index([startTime])
  @@index([status])
}

// ContractorInvoice - Invoices created by contractors for their customers
model ContractorInvoice {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber String @unique
  contractorId  String @db.Uuid
  customerId    String @db.Uuid

  // Line Items (stored as JSON array)
  // Each item: { description: string, quantity: number, unitPrice: number, type: 'labor' | 'material' | 'other' }
  lineItems Json[] @default([]) @db.Json

  // Totals
  subtotal  Decimal  @db.Decimal(12, 2)
  taxRate   Decimal? @db.Decimal(5, 2)
  taxAmount Decimal? @db.Decimal(12, 2)
  total     Decimal  @db.Decimal(12, 2)

  // Payment tracking
  depositPaid Decimal @default(0) @db.Decimal(12, 2)
  amountPaid  Decimal @default(0) @db.Decimal(12, 2)
  amountDue   Decimal @db.Decimal(12, 2)

  // Status
  status   String    @default("draft") // draft, sent, viewed, partial, paid, overdue, cancelled
  sentAt   DateTime? @db.Timestamp(6)
  viewedAt DateTime? @db.Timestamp(6)
  paidAt   DateTime? @db.Timestamp(6)
  dueDate  DateTime  @db.Timestamp(6)

  // Payment Processing
  stripePaymentIntentId String?
  paymentLink           String?

  // Notes
  notes String?
  terms String?

  // Job/Appointment linkage
  jobId         String? @db.Uuid
  appointmentId String? @db.Uuid

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  contractor ContractorProfile          @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  payments   ContractorInvoicePayment[]

  @@index([contractorId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
}

// ContractorInvoicePayment - Supports partial payments on invoices
model ContractorInvoicePayment {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId       String  @db.Uuid
  amount          Decimal @db.Decimal(12, 2)
  method          String // 'card', 'bank', 'cash', 'check'
  stripePaymentId String?
  notes           String?

  createdAt DateTime @default(now()) @db.Timestamp(6)

  invoice ContractorInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ContractorCustomer - CRM for contractors to manage leads and customers
model ContractorCustomer {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorId String  @db.Uuid
  userId       String? @db.Uuid // if registered user

  // Contact Info
  name    String
  email   String
  phone   String?
  address Json?   @db.Json

  // CRM Data
  status String   @default("lead") // lead, prospect, customer, inactive
  source String? // 'marketplace', 'subdomain', 'referral', 'job_posting'
  tags   String[] @default([])
  notes  Json[]   @default([]) @db.Json // { text: string, createdAt: Date, createdBy: string }

  // Stats
  totalJobs       Int       @default(0)
  totalSpent      Decimal   @default(0) @db.Decimal(12, 2)
  lastContactedAt DateTime? @db.Timestamp(6)
  lastJobAt       DateTime? @db.Timestamp(6)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  contractor ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([contractorId, email])
  @@index([contractorId])
  @@index([status])
}

// ContractorAvailability - Scheduler availability settings for contractors
model ContractorAvailability {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractorId String @unique @db.Uuid

  // Weekly schedule - Monday
  mondayStart   String? // "09:00" format
  mondayEnd     String? // "17:00" format
  mondayEnabled Boolean @default(true)

  // Weekly schedule - Tuesday
  tuesdayStart   String?
  tuesdayEnd     String?
  tuesdayEnabled Boolean @default(true)

  // Weekly schedule - Wednesday
  wednesdayStart   String?
  wednesdayEnd     String?
  wednesdayEnabled Boolean @default(true)

  // Weekly schedule - Thursday
  thursdayStart   String?
  thursdayEnd     String?
  thursdayEnabled Boolean @default(true)

  // Weekly schedule - Friday
  fridayStart   String?
  fridayEnd     String?
  fridayEnabled Boolean @default(true)

  // Weekly schedule - Saturday
  saturdayStart   String?
  saturdayEnd     String?
  saturdayEnabled Boolean @default(false)

  // Weekly schedule - Sunday
  sundayStart   String?
  sundayEnd     String?
  sundayEnabled Boolean @default(false)

  // Scheduling settings
  bufferMinutes  Int @default(30) // Buffer time between appointments
  minNoticeHours Int @default(24) // Minimum notice required for booking
  maxAdvanceDays Int @default(60) // How far in advance bookings can be made

  // Blocked dates (stored as ISO date strings)
  blockedDates DateTime[] @default([])

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  contractor ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)
}

// ============= JOB GUARANTEE SYSTEM =============

// JobGuaranteeHold - Fund holds for job guarantee protection
// Holds funds for 7 days after job completion before releasing to contractor
// Supports dispute resolution and refunds
model JobGuaranteeHold {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId        String @db.Uuid
  contractorId String @db.Uuid
  customerId   String @db.Uuid

  // Hold amount
  amount Decimal @db.Decimal(12, 2)

  // Status tracking
  // held: funds are being held
  // released: funds released to contractor
  // disputed: customer filed a dispute
  // refunded: funds refunded to customer
  status String @default("held") // held, released, disputed, refunded

  // Timing
  heldAt     DateTime  @default(now()) @db.Timestamp(6)
  releaseAt  DateTime  @db.Timestamp(6) // 7 days after job completion
  releasedAt DateTime? @db.Timestamp(6)

  // Dispute linkage (uses existing Dispute model)
  disputeId String? @db.Uuid

  // Stripe transfer tracking
  stripeTransferId String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([contractorId])
  @@index([status])
  @@index([releaseAt])
}

// ============= ADVANCED ANALYTICS SYSTEM =============

// PageView - Detailed page view tracking with session data
model PageView {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId    String
  userId       String?  @db.Uuid
  path         String
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  utmTerm      String?
  utmContent   String?
  country      String?
  region       String?
  city         String?
  device       String?
  browser      String?
  os           String?
  screenWidth  Int?
  screenHeight Int?
  timeOnPage   Int? // milliseconds
  scrollDepth  Int? // percentage 0-100
  exitPage     Boolean  @default(false)
  bounced      Boolean  @default(false)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@index([path])
  @@index([createdAt])
  @@index([exitPage])
}

// ClickEvent - Click tracking for heatmap generation
model ClickEvent {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId    String
  userId       String?  @db.Uuid
  path         String
  elementId    String?
  elementClass String?
  elementTag   String?
  elementText  String?
  xPosition    Int?
  yPosition    Int?
  timestamp    DateTime @default(now()) @db.Timestamp(6)

  @@index([sessionId])
  @@index([path])
  @@index([timestamp])
}

// UserSession - Complete user session tracking
model UserSession {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String    @unique
  userId          String?   @db.Uuid
  startTime       DateTime  @default(now()) @db.Timestamp(6)
  endTime         DateTime?
  duration        Int? // milliseconds
  pageCount       Int       @default(0)
  clickCount      Int       @default(0)
  converted       Boolean   @default(false)
  conversionType  String? // signup, application, payment, etc
  conversionValue Decimal?  @db.Decimal(12, 2)
  landingPage     String?
  exitPage        String?
  referrer        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  device          String?
  browser         String?
  os              String?
  country         String?
  region          String?
  city            String?

  @@index([sessionId])
  @@index([userId])
  @@index([startTime])
  @@index([converted])
}

// FormInteraction - Form field tracking for optimization
model FormInteraction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId String
  userId    String?  @db.Uuid
  formId    String
  formName  String?
  fieldName String?
  action    String // focus, blur, change, submit, abandon
  timeSpent Int? // milliseconds on field
  completed Boolean  @default(false)
  timestamp DateTime @default(now()) @db.Timestamp(6)

  @@index([sessionId])
  @@index([formId])
  @@index([completed])
}

// ConversionFunnel - Funnel step tracking
model ConversionFunnel {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId      String
  userId         String?  @db.Uuid
  step           String // visit, view_listing, start_application, submit_application, payment
  stepOrder      Int
  completed      Boolean  @default(false)
  timeToComplete Int? // milliseconds from previous step
  metadata       Json?    @db.Json
  timestamp      DateTime @default(now()) @db.Timestamp(6)

  @@index([sessionId])
  @@index([step])
  @@index([completed])
}

// ============= EVENT SYSTEM MODELS =============
// These models replace cron jobs with an event-driven system

// SystemEvent - Stores all system events for audit trail and recovery
model SystemEvent {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type        String    // Event type (e.g., 'lease.tenant_signed')
  payload     Json      @db.Json // Event data
  processed   Boolean   @default(false)
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  processedAt DateTime? @db.Timestamp(6)

  @@index([type])
  @@index([processed])
  @@index([createdAt])
}

// ScheduledJob - Database-backed job queue that replaces cron jobs
model ScheduledJob {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type         String    // Job type (e.g., 'send_reminder')
  payload      Json      @db.Json // Job data
  scheduledFor DateTime  @db.Timestamp(6) // When to run the job
  priority     Int       @default(0) // Higher = more important
  status       String    @default("pending") // pending, processing, completed, failed
  retryCount   Int       @default(0)
  maxRetries   Int       @default(3)
  lastError    String?
  createdAt    DateTime  @default(now()) @db.Timestamp(6)
  completedAt  DateTime? @db.Timestamp(6)

  @@index([type])
  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
}
